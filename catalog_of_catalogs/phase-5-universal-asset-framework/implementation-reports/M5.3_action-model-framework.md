# M5.3: Action Model + Framework

**Date**: 2026-02-16
**Status**: Complete
**Phase**: Phase 5 - Universal Asset Framework

## Overview

This milestone delivers the standard `:action` endpoint infrastructure for the catalog plugin framework. It introduces a generic action dispatch model with discovery, dry-run support, and a persistent overlay store for metadata mutations. Rather than mutating the source YAML data, user-applied changes (tags, annotations, lifecycle transitions) are stored in a database-backed overlay layer keyed by composite primary key (plugin_name, entity_kind, entity_uid).

## Goal

Implement standard `:action` endpoints with discovery, dispatch, dry-run capability, and an overlay store for persisting metadata mutations without modifying upstream source data.

## Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/plugin/action_types.go` | Core action type definitions: `ActionScope` enum (`source`, `asset`), `ActionRequest` (action name, dryRun flag, params map), `ActionResult` (status, message, data), and the `ActionProvider` interface (`HandleAction`, `ListActions`) |
| `pkg/catalog/plugin/action_handler.go` | Generic HTTP handler for `:action` endpoints -- `actionHandler()` validates the action exists in the plugin's declared list, checks dry-run support, then dispatches to `ActionProvider.HandleAction()`; `actionsListHandler()` returns the discovery list for a given scope |
| `pkg/catalog/plugin/builtin_actions.go` | `BuiltinActionHandler` with `HandleTag`, `HandleAnnotate`, `HandleDeprecate` methods -- all three support dry-run (returning a preview without persisting), use the overlay store for persistence, and include helper functions `extractStringSlice` and `extractStringMap` for type-safe parameter extraction from `map[string]any` |
| `pkg/catalog/plugin/overlay_store.go` | `OverlayRecord` GORM model with composite PK (plugin_name, entity_kind, entity_uid), custom `StringSlice` and `JSONMap` GORM types (serialized as JSON text in the DB), and `OverlayStore` with `Get`, `Upsert`, `Delete`, `ListByPlugin`, and `AutoMigrate` operations |
| `pkg/catalog/plugin/action_handler_test.go` | 9 test cases for the action handler (501 for non-ActionProvider plugins, 400 for missing/unknown actions, 400 for unsupported dry-run, valid source dispatch, valid asset dispatch, handler error propagation, invalid JSON body, dry-run with support) plus 2 tests for the actions list handler (empty list for non-ActionProvider, populated list for ActionProvider) |
| `pkg/catalog/plugin/overlay_store_test.go` | 7 overlay store tests (upsert-and-get, update-existing with dedup, get-not-found, delete, delete-non-existent, list-by-plugin with cross-plugin isolation, nil-fields handling) plus 3 builtin action handler tests (tag with persistence + dry-run + missing param, annotate with merge semantics + dry-run, deprecate with default/custom phase + dry-run) plus 1 test for `BuiltinActionDefinitions()` verifying all 3 definitions have SupportsDryRun and Idempotent set to true |

## Files Modified

| File | Change |
|------|--------|
| `pkg/catalog/plugin/management_handlers.go` | Added action endpoint wiring inside `managementRouter()`: `POST /sources/{sourceId}:action` and `POST /entities/{entityName}:action` (both require RoleOperator), plus read-only discovery endpoints `GET /actions/source` and `GET /actions/asset`. Also added `ActionProvider` to the management interface detection in `MountRoutes()` logging. |
| `pkg/catalog/plugin/server.go` | Added `overlayStore` field and `GetOverlayStore()` accessor to `Server`. During `Init()`, auto-migrates the `catalog_overlays` table alongside the existing `refresh_status` table when a DB is available. Added `ActionProvider` to the management capability detection in `MountRoutes()` and `pluginsHandler()`. |

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Overlay store with composite PK (plugin_name, entity_kind, entity_uid) | Provides cross-plugin isolation and entity-kind namespacing without requiring per-plugin tables. A single `catalog_overlays` table serves all plugins. | Separate table per plugin (too many tables), single UID column (risk of collision across plugins) |
| Actions declared and validated against plugin's `ListActions()` | Prevents typos and undeclared actions from reaching the handler. Discovery-first design means clients can introspect available actions before calling them. | Accept any action string and let the handler reject unknowns (less discoverable) |
| Dry-run declared per action definition | Not all actions are safely previewable. The handler rejects dry-run requests for actions that don't declare support, giving clear errors rather than silent no-ops. | Global dry-run flag on the plugin (too coarse), always allow dry-run (unsafe for destructive actions) |
| Builtin actions (tag, annotate, deprecate) use the overlay store rather than mutating source YAML | Preserves source data integrity. Source YAML files remain the single source of truth for upstream data; user-applied metadata is an additive layer. | Mutate the source file (risks data loss, merge conflicts), store in a separate metadata service (over-engineering) |
| `StringSlice` and `JSONMap` custom GORM types | MySQL and SQLite lack native array/map column types. Storing as JSON text with `Scan`/`Value` interfaces provides portable serialization with type-safe Go access. | PostgreSQL arrays (not portable), separate join tables (complex queries for simple overlays) |
| Annotations use merge semantics | `HandleAnnotate` merges new annotations into existing ones rather than replacing. This matches Kubernetes annotation semantics and avoids accidental data loss from partial updates. | Full replace (loses existing annotations), append-only (no way to update a key) |
| `BuiltinActionHandler` is a reusable struct, not an interface | Plugins compose it by delegation (calling `handler.HandleTag()` etc. in their `HandleAction` switch). This avoids complex inheritance chains and keeps the dispatch logic visible in the plugin code. | Interface with default methods (Go lacks this), embedding (hides dispatch logic) |

## Test Results

All 21 test cases pass:

**Action Handler Tests (11 tests)**:
- `TestActionHandler/plugin_without_ActionProvider_returns_501` -- non-implementing plugin returns 501
- `TestActionHandler/missing_action_field_returns_400` -- empty action string rejected
- `TestActionHandler/unknown_action_returns_400` -- undeclared action rejected
- `TestActionHandler/dry-run_on_action_without_support_returns_400` -- dry-run blocked when not declared
- `TestActionHandler/valid_source_action_dispatches_correctly` -- source scope with params dispatched to handler
- `TestActionHandler/valid_asset_action_dispatches_correctly` -- asset scope dispatched with correct targetID
- `TestActionHandler/handler_error_returns_500` -- handler errors propagated as 500
- `TestActionHandler/invalid_JSON_body_returns_400` -- malformed body rejected
- `TestActionHandler/dry-run_with_support_dispatches_correctly` -- dry-run flag passed through
- `TestActionsListHandler/plugin_without_ActionProvider_returns_empty_list` -- graceful fallback
- `TestActionsListHandler/plugin_with_actions_returns_list` -- correct count and definitions

**Overlay Store Tests (7 tests)**:
- `TestOverlayStore_UpsertAndGet` -- round-trip create and retrieve with all fields
- `TestOverlayStore_Upsert_UpdateExisting` -- update-in-place with ON CONFLICT, verifies single record
- `TestOverlayStore_Get_NotFound` -- returns nil, nil for missing record
- `TestOverlayStore_Delete` -- removes record, verified with subsequent Get
- `TestOverlayStore_Delete_NonExistent` -- no error for missing record
- `TestOverlayStore_ListByPlugin` -- cross-plugin isolation (2 mcp, 1 model, 0 nonexistent)
- `TestOverlayStore_NilFields` -- nil Tags/Annotations/Labels round-trip correctly

**Builtin Action Handler Tests (3 groups + 1)**:
- `TestBuiltinActionHandler_Tag` -- set tags, dry-run tag (no overlay created), missing tags param error
- `TestBuiltinActionHandler_Annotate` -- set annotations, merge annotations (both keys present), dry-run annotate
- `TestBuiltinActionHandler_Deprecate` -- deprecate (default phase), custom phase, dry-run deprecate
- `TestBuiltinActionDefinitions` -- 3 definitions, all with SupportsDryRun and Idempotent true

## Acceptance Criteria

| AC | Status |
|----|--------|
| `ActionProvider` interface defined with `HandleAction` and `ListActions` | Done |
| Generic HTTP handler validates action existence and dry-run support before dispatch | Done |
| Overlay store persists tags, annotations, labels, lifecycle with composite PK | Done |
| `BuiltinActionHandler` provides tag, annotate, deprecate with dry-run support | Done |
| Management router wires `:action` endpoints for both source and asset scopes | Done |
| Action discovery endpoints return declared actions per scope | Done |
| Server auto-migrates overlay table on init | Done |
| All 21 tests pass | Done |

## Status

**Complete** -- The action model and framework is fully implemented with generic dispatch, overlay persistence, builtin actions, and comprehensive test coverage. Both MCP and Model plugins can now implement `ActionProvider` to expose actions through the standard `:action` endpoints.
