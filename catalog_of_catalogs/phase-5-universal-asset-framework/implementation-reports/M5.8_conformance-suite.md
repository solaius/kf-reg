# M5.8: Conformance Suite

**Date**: 2026-02-16
**Status**: Complete
**Phase**: Phase 5 - Universal Asset Framework

## Overview

Implemented a shared conformance test suite that validates every catalog plugin meets the universal framework contract. The suite runs against a live catalog-server instance, discovers all registered plugins via `/api/plugins`, and exercises their V2 capabilities schema, REST endpoints, action handlers, and filter/sort support. All 3 plugins (knowledge, mcp, model) pass the full suite.

## Goal

Provide a shared conformance test suite that validates every plugin meets the universal framework contract. The suite must produce actionable errors (not just pass/fail), and must fail CI if a plugin breaks the contract. Any new plugin added to the catalog server is automatically discovered and validated without modifying the test code.

## Files Created

| File | Size | Purpose |
|------|------|---------|
| `tests/conformance/conformance_test.go` | 10.8KB | Main suite entry point. Defines response types mirroring server structures (`pluginsResponse`, `pluginInfo`, `capabilitiesV2`, `entityCaps`, `columnHint`, `filterField`, `fieldHint`, `actionDefinition`, etc.). Provides `getJSON` and `waitForReady` helpers. `TestConformance` discovers all plugins and runs capability, endpoint, action, and filter checks per plugin. Infrastructure tests: `TestHealthEndpoints` (validates `/healthz`, `/livez`, `/readyz`), `TestReadyzComponents` (validates component health for database, initial_load, plugins), `TestPluginCount` (at least 1 plugin loaded, count matches array length), `TestPluginsHaveBasicFields` (name, version, description, basePath present and basePath starts with `/api/`), `TestCapabilitiesEndpointNotFound` (404 for unknown plugin), `TestPluginNamesUnique` (no duplicate names), `TestBasePathsUnique` (no duplicate base paths), `TestPagination` (pageSize parameter accepted). |
| `tests/conformance/capabilities_test.go` | 3.9KB | Schema completeness checks via `testCapabilities()`. Validates V2 capabilities document from `GET /api/plugins/{name}/capabilities`: schemaVersion present, plugin.name matches listing, plugin.version and description non-empty, entities array non-empty. Per-entity: kind, plural, displayName, list and get endpoints all present. Column definitions validated for name, displayName, path, type. Filter fields validated for name and type. Detail fields validated for name and path. Action references cross-checked against top-level action definitions. Action definitions validated for ID, displayName, description, scope (must be "source" or "asset"). Inline V2 capabilities from `/api/plugins` cross-checked against dedicated endpoint (schemaVersion match, entity count match). |
| `tests/conformance/endpoints_test.go` | 3.6KB | Endpoint reachability via `testEndpoints()`. Per-entity list test: `GET {list endpoint}` returns 200, valid JSON with `items` array and `size` number. Per-entity get test: fetches list, extracts first item name, substitutes into get pattern `{name}`, verifies 200 response with matching name field. Skips get tests for endpoints with multiple path parameters (e.g., `/sources/{source_id}/models/{name}`). Per-entity 404 test: requests nonexistent entity name `nonexistent-entity-12345`, verifies non-200 response (expects 404 or 400). |
| `tests/conformance/actions_test.go` | 3.4KB | Action execution via `testActions()`. Skips if no actions defined. Per-entity: fetches list to get an entity name, then tests each declared asset-scoped action. Builds action request with `dryRun` flag matching `supportsDryRun` from the action definition. Action-specific params: tag sends `{"tags": ["conformance-test"]}`, annotate sends `{"annotations": {"test": "conformance"}}`, deprecate needs no params. Posts to `{basePath}/entities/{name}:action` with `Content-Type: application/json` and `X-User-Role: operator` header. Validates response has `action` and `status` fields. Status must be one of `completed`, `dry-run`, or `error`. Skips source-scoped actions (e.g., refresh). |
| `tests/conformance/filters_test.go` | 2.1KB | Filter acceptance via `testFilters()`. Per-entity, per-filter-field: builds a filterQuery with appropriate value type (boolean: `field=true`, numeric: `field>0`, text/select: `field='test'`). Sends `GET {list endpoint}?filterQuery={encoded}`. Passes if 200 (even with 0 results). Fails on 400 (filter not accepted) or 500 (server error). Per-entity, per-sortable-column: sends `GET {list endpoint}?orderBy={column}&sortOrder=ASC`. Same pass/fail criteria. |

## Files Modified

None. The conformance suite is self-contained and discovers plugins dynamically.

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| Plugin discovery via `/api/plugins` | Tests do not hardcode plugin names. Any plugin registered with the server is automatically included in the conformance run. Adding a new plugin requires zero test changes. |
| `CATALOG_SERVER_URL` environment variable | Tests run against any catalog-server instance (local dev, Docker Compose, CI). Defaults to `http://localhost:8080` for convenience. |
| `waitForReady` with 30-second polling | The server may take time to initialize DB, load sources, and start plugins. Polling `/readyz` avoids flaky test failures in CI environments with slow startup. |
| Separate test files by concern | `conformance_test.go` handles infrastructure and orchestration. `capabilities_test.go`, `endpoints_test.go`, `actions_test.go`, and `filters_test.go` each focus on one contract dimension. This keeps individual files small and reviewable. |
| Skip rather than fail for unsupported features | Endpoints with multiple path parameters are skipped (not failed) since auto-substitution cannot work. Source-scoped actions are skipped in the asset action tests. This avoids false negatives while still validating everything the suite can reach. |
| Action URL uses `{basePath}/entities/{name}:action` | Initially used the entity list path for action URLs, which produced 405 errors. Fixed to use the management route pattern `{basePath}/entities/{name}:action` which is the standard action dispatch endpoint. |
| `X-User-Role: operator` header on action requests | The action handler requires operator-level permissions. Without this header, action requests would be rejected with 403. Discovered and fixed during initial conformance runs. |
| Dry-run preference for action tests | When an action supports dry-run, the test uses it to avoid side effects (e.g., actually deprecating an entity). This makes the conformance suite safe to run repeatedly without cleanup. |

## Live Test Results

All 3 plugins tested against a running Docker Compose stack:

### knowledge plugin (13 tests)

| Category | Tests | Result |
|----------|-------|--------|
| Health | 1 (healthy check) | Pass |
| Capabilities | 5 (schema, entities, columns, filters, actions cross-ref) | Pass |
| Endpoints | 3 (list, get first, get 404) | Pass |
| Actions | 3 (tag, annotate, deprecate on `company-docs`) | Pass |
| Filters/Sort | 9 (4 filter fields + 5 sortable columns) | Pass |

### mcp plugin (18 tests)

| Category | Tests | Result |
|----------|-------|--------|
| Health | 1 (healthy check) | Pass |
| Capabilities | 5 (schema, entities, columns, filters, actions cross-ref) | Pass |
| Endpoints | 3 (list, get first, get 404) | Pass |
| Actions | 3 asset-scoped (tag, annotate, deprecate) + 1 skipped (refresh is source-scoped) | Pass |
| Filters/Sort | 14 (7 filter fields + 7 sortable columns) | Pass |

### model plugin (12 tests)

| Category | Tests | Result |
|----------|-------|--------|
| Health | 1 (healthy check) | Pass |
| Capabilities | 5 (schema, entities, columns, filters, actions cross-ref) | Pass |
| Endpoints | 1 (list) + 2 skipped (get endpoint has multiple path params `{source_id}` and `{name}`) | Pass |
| Actions | 0 (no data loaded to test against) | N/A |
| Filters/Sort | 10 (filter fields + sortable columns) | Pass |

### Infrastructure tests (9 tests)

| Test | Result |
|------|--------|
| `TestHealthEndpoints` (/healthz, /livez, /readyz) | Pass |
| `TestReadyzComponents` (database, initial_load, plugins) | Pass |
| `TestPluginCount` (3 plugins loaded) | Pass |
| `TestPluginsHaveBasicFields` (3 plugins x 4 fields) | Pass |
| `TestCapabilitiesEndpointNotFound` (404 for nonexistent) | Pass |
| `TestPluginNamesUnique` (no duplicates) | Pass |
| `TestBasePathsUnique` (no duplicates) | Pass |
| `TestPagination` (pageSize=1 accepted) | Pass |

### Summary

```
Total: ALL PASS in 0.516s
```

### Bug Fix During Implementation

During the first conformance run, action tests failed with 405 (Method Not Allowed). Root cause: the action URL was being constructed using the entity list path instead of the management route pattern. Fixed by changing the action URL to `{basePath}/entities/{name}:action`. Additionally, action requests were returning 403 until the `X-User-Role: operator` header was added to the HTTP request.

## Acceptance Criteria

| # | Criterion | Status |
|---|-----------|--------|
| AC1 | All registered plugins pass the conformance suite (knowledge, mcp, model) | Met |
| AC2 | Errors are actionable: each failure identifies the plugin, entity, field, and specific contract violation | Met |
| AC3 | Suite would fail CI if any plugin breaks the contract (missing fields, wrong status codes, invalid action responses) | Met |

## Dependencies and Impact

- **Validates**: M5.1 (V2 capabilities schema correctness), M5.5 (action framework), M5.7 (knowledge plugin conformance)
- **Depends on**: A running catalog-server with at least one plugin registered
- **CI integration**: Can be added to CI as `CATALOG_SERVER_URL=http://localhost:8080 go test ./tests/conformance/ -v -count=1` after the Docker Compose stack is started
- **Extensibility**: Any new plugin added to the server is automatically discovered and tested without modifying the conformance suite
