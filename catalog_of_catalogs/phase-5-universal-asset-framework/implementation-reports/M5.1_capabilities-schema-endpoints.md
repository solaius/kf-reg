# M5.1: Capabilities Schema + Endpoints

**Date**: 2026-02-16
**Status**: Complete
**Phase**: Phase 5 - Universal Asset Framework

## Overview

Expanded the plugin capabilities system from the existing V1 `PluginCapabilities` struct to a comprehensive V2 discovery document (`PluginCapabilitiesV2`). Added a per-plugin REST endpoint that returns the full V2 capabilities document, and updated the `/api/plugins` listing to inline V2 capabilities for each registered plugin.

## Goal

Enable generic UI and CLI clients to discover everything they need to render plugin entities without hardcoded knowledge of specific plugins. The V2 capabilities document describes entities, endpoints, columns, filters, detail fields, UI hints, and available actions -- providing a complete self-description contract that drives dynamic rendering.

## Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/plugin/capabilities_types.go` | Defines the V2 capabilities type system: `PluginCapabilitiesV2`, `PluginMeta`, `EntityCapabilities`, `EntityEndpoints`, `EntityFields`, `V2ColumnHint`, `V2FilterField`, `V2FieldHint`, `EntityUIHints`, `SourceCapabilities`, `ActionDefinition` |
| `pkg/catalog/plugin/capabilities_builder.go` | `BuildCapabilitiesV2()` helper that assembles a V2 document from a plugin. Uses `CapabilitiesV2Provider` directly if available, otherwise falls back to synthesizing V2 from V1 `CapabilitiesProvider`, `SourceManager`, and `RefreshProvider` interfaces. Includes `pluralize()` utility for URL path generation. |
| `pkg/catalog/plugin/capabilities_test.go` | Comprehensive test suite with 10 test functions covering V2 provider passthrough, V1 fallback synthesis, source manager detection, bare plugins, list-only endpoints, JSON round-trip serialization, HTTP endpoint responses (200 and 404), plugins listing V2 inline, pluralization, and V1 fallback via HTTP endpoint. |

## Files Modified

| File | Change |
|------|--------|
| `pkg/catalog/plugin/plugin.go` | Added `CapabilitiesV2Provider` interface with `GetCapabilitiesV2() PluginCapabilitiesV2` method. Comment reference to `AssetMapperProvider` in `asset_mapper.go`. |
| `pkg/catalog/plugin/server.go` | Added `capabilitiesHandler` method implementing `GET /api/plugins/{pluginName}/capabilities`. Updated `MountRoutes()` to register the new route. Updated `pluginsHandler` to build and inline `CapabilitiesV2` for each healthy plugin. |
| `catalog/plugins/mcp/management.go` | Implemented `GetCapabilitiesV2()` on `McpServerCatalogPlugin` with 7 columns, 7 filter fields, 14 detail fields (organized into 3 sections: Overview, Connection, Statistics), UI hints, and 4 action definitions (tag, annotate, deprecate, refresh). Added compile-time interface assertion for `CapabilitiesV2Provider`. |

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| V2-prefixed type names (`V2ColumnHint`, `V2FilterField`, `V2FieldHint`) | Avoids naming conflicts with existing `ColumnHint` and `FieldHint` types in `management_types.go` which serve the V1 `UIHintsProvider` interface. Both type families coexist without ambiguity. |
| `SchemaVersion` field in `PluginCapabilitiesV2` | Future-proofs the document structure. Clients can check `schemaVersion: "v1"` and adapt if the schema evolves to "v2" later. |
| `BuildCapabilitiesV2()` builder with V1 fallback | Plugins that only implement the simpler V1 `CapabilitiesProvider` still get a valid V2 document automatically. New plugins can implement `CapabilitiesV2Provider` for full control. This ensures backward compatibility while encouraging adoption of the richer schema. |
| Capabilities endpoint at `/api/plugins/{pluginName}/capabilities` | Follows REST conventions. Nested under `/api/plugins/` to keep plugin metadata grouped. Returns 404 with a JSON error body if the plugin is not found. |
| V2 capabilities inlined in `/api/plugins` listing | Clients can fetch all plugin capabilities in a single request without needing per-plugin round-trips. The `capabilitiesV2` field is present for every healthy plugin. |
| MCP plugin declares 4 actions by ID reference | Actions are defined at the top level of the V2 document and referenced by ID in entity `actions` arrays. This allows the same action (e.g., "refresh") to apply to multiple entity kinds without duplication. |

## Test Results

All 10 test functions pass:

| Test | Coverage |
|------|----------|
| `TestBuildCapabilitiesV2_FromV2Provider` | V2 provider passthrough returns the exact document the plugin provides |
| `TestBuildCapabilitiesV2_FromV1Capabilities` | V1 fallback builds correct entities, endpoints, pluralization; no sources on V1-only plugin |
| `TestBuildCapabilitiesV2_WithSourceManager` | Detects `SourceManager` + `RefreshProvider` and populates `Sources.Manageable` and `Sources.Refreshable` |
| `TestBuildCapabilitiesV2_BarePlugin` | Plugin with no optional interfaces yields empty entities, nil sources, empty actions |
| `TestBuildCapabilitiesV2_V1ListOnlyNoGet` | V1 plugin with `ListEntities=true, GetEntity=false` produces list endpoint but empty get endpoint |
| `TestPluginCapabilitiesV2_JSONRoundTrip` | Full V2 document with columns, filters, detail fields, UI hints, sources, and actions serializes/deserializes correctly |
| `TestCapabilitiesEndpoint_ReturnsV2` | `GET /api/plugins/mytest/capabilities` returns 200, `Content-Type: application/json`, valid V2 document |
| `TestCapabilitiesEndpoint_NotFound` | `GET /api/plugins/nonexistent/capabilities` returns 404 with JSON error containing the plugin name |
| `TestPluginsEndpoint_IncludesV2Capabilities` | `GET /api/plugins` response includes `capabilitiesV2` with correct schema version and entities |
| `TestCapabilitiesEndpoint_V1FallbackBuild` | V1-only plugin served through HTTP endpoint returns built V2 document with correct computed base path and endpoints |
| `TestPluralize` | Covers `Model->models`, `McpServer->mcpservers`, `ModelVersion->modelversions`, `item->items`, empty string |

```
go test ./pkg/catalog/plugin/... -v -run "TestBuildCapabilitiesV2|TestPluginCapabilitiesV2|TestCapabilitiesEndpoint|TestPluginsEndpoint|TestPluralize" -count=1
```

## Acceptance Criteria

| # | Criterion | Status |
|---|-----------|--------|
| AC1 | `GET /api/plugins/{name}/capabilities` returns valid JSON with entities, endpoints, fields, and actions | Met |
| AC2 | Entities array is present with kind, plural, displayName, endpoints, and fields | Met |
| AC3 | `GET /api/plugins` listing includes `capabilitiesV2` inline for each healthy plugin | Met |
| AC4 | `schemaVersion` field is present in every V2 document (set to "v1") | Met |
| AC5 | All tests pass, including endpoint tests, builder tests, and JSON round-trip | Met |

## Type Inventory

The V2 capabilities type system comprises 10 types:

| Type | Role |
|------|------|
| `PluginCapabilitiesV2` | Top-level discovery document envelope |
| `PluginMeta` | Plugin identity (name, version, description, displayName, icon) |
| `EntityCapabilities` | Per-entity kind descriptor with endpoints, fields, UI hints, action refs |
| `EntityEndpoints` | REST paths for list, get, and action operations |
| `EntityFields` | Groups columns, filter fields, and detail fields |
| `V2ColumnHint` | Column definition for list/table views (name, path, type, sortable, width) |
| `V2FilterField` | Filterable field for list views (name, type, options, operators) |
| `V2FieldHint` | Field definition for detail views (name, path, type, section) |
| `EntityUIHints` | Rendering hints (icon, color, name field, ordered section names) |
| `SourceCapabilities` | Source management flags (manageable, refreshable, supported types) |
| `ActionDefinition` | Action descriptor (id, displayName, scope, supportsDryRun, idempotent, destructive) |

## Dependencies and Impact

- **Enables**: M5.3 (generic UI components can read V2 capabilities to render any plugin), M5.4 (CLI v2 can use V2 capabilities for dynamic table/filter rendering)
- **Depends on**: Phase 1 plugin framework (`CatalogPlugin`, `CapabilitiesProvider` interfaces)
- **Backward compatible**: V1 `PluginCapabilities` and `CapabilitiesProvider` continue to work unchanged. V2 is additive.
