# M5.4: Model + MCP Plugin Updates

**Date**: 2026-02-16
**Status**: Complete
**Phase**: Phase 5 - Universal Asset Framework

## Overview

This milestone upgrades both existing catalog plugins (MCP Servers and Model Catalog) to implement all Phase 5 framework interfaces. Each plugin now returns full V2 capabilities discovery documents, implements the `ActionProvider` interface with source-scoped refresh and asset-scoped tag/annotate/deprecate actions (delegating to `BuiltinActionHandler`), and provides an `AssetMapper` that projects its native entity types into the universal `AssetResource` contract. Compile-time interface assertions guarantee conformance.

## Goal

Both existing plugins return full V2 capabilities, implement baseline actions (refresh, tag, annotate, deprecate), and provide asset mappers that project their native entities into the universal `AssetResource` format.

## Files Created

| File | Purpose |
|------|---------|
| `catalog/plugins/mcp/actions.go` | `ActionProvider` implementation for the MCP plugin. Dispatches source-scoped actions to `handleSourceAction` (refresh via `p.Refresh()`) and asset-scoped actions to `handleAssetAction` (tag, annotate, deprecate via `BuiltinActionHandler`). `ListActions` returns a `refresh` action for source scope and `BuiltinActionDefinitions()` for asset scope. Includes `builtinActionHandler()` helper that lazily constructs a `BuiltinActionHandler` from the shared DB. Compile-time assertion: `var _ plugin.ActionProvider = (*McpServerCatalogPlugin)(nil)`. |
| `catalog/plugins/mcp/asset_mapper.go` | `AssetMapperProvider` implementation for the MCP plugin. Returns an `mcpAssetMapper` that supports `McpServer` kind. `MapToAsset` accepts `openapi.McpServer`, `*openapi.McpServer`, or `map[string]any` and projects all MCP-specific fields (serverUrl, transportType, deploymentMode, provider, toolCount, resourceCount, promptCount, verified, certified, logo, etc.) into an `AssetResource` with apiVersion `catalog/v1alpha1` and kind `McpServer`. Compile-time assertion: `var _ plugin.AssetMapperProvider = (*McpServerCatalogPlugin)(nil)`. |
| `catalog/plugins/model/actions.go` | `ActionProvider` implementation for the Model plugin. Structurally identical to the MCP variant but uses `PluginName` "model" and entity kind "CatalogModel" for the `BuiltinActionHandler`. Source-scoped refresh delegates to `p.Refresh()`. Compile-time assertion: `var _ plugin.ActionProvider = (*ModelCatalogPlugin)(nil)`. |
| `catalog/plugins/model/asset_mapper.go` | `AssetMapperProvider` implementation for the Model plugin. Returns a `modelAssetMapper` that supports `CatalogModel` kind. `MapToAsset` accepts `apimodels.CatalogModel`, `*apimodels.CatalogModel`, or `map[string]any` and projects model-specific fields (provider, license, licenseLink, maturity, libraryName, logo, readme, tasks, language, source_id) into an `AssetResource` with apiVersion `catalog/v1alpha1` and kind `CatalogModel`. Handles nullable pointer fields (`*string`, `*int32`) gracefully. Compile-time assertion: `var _ plugin.AssetMapperProvider = (*ModelCatalogPlugin)(nil)`. |

## Files Modified

| File | Change |
|------|--------|
| `catalog/plugins/mcp/management.go` | Added `CapabilitiesV2Provider` compile-time assertion. Implemented `GetCapabilitiesV2()` returning a full `PluginCapabilitiesV2` document with: `SchemaVersion` "v1"; `PluginMeta` (name "mcp", displayName "MCP Servers", icon "server"); one entity of kind `McpServer` with 7 column hints, 7 filter fields, 14 detail fields (grouped into Overview/Connection/Statistics sections), UI hints, and declared actions [tag, annotate, deprecate, refresh]; source capabilities (manageable, refreshable, type "yaml"); and 4 action definitions. All 7 compile-time interface assertions present: `SourceManager`, `RefreshProvider`, `DiagnosticsProvider`, `CapabilitiesProvider`, `CapabilitiesV2Provider`, `UIHintsProvider`, `CLIHintsProvider`. |
| `catalog/plugins/model/management.go` | Added `CapabilitiesV2Provider` compile-time assertion. Implemented `GetCapabilitiesV2()` returning a full `PluginCapabilitiesV2` document with: `SchemaVersion` "v1"; `PluginMeta` (name "model", displayName "Models", icon "model"); one entity of kind `CatalogModel` with 5 column hints, 5 filter fields, 10 detail fields (grouped into Overview/Details/Documentation sections), UI hints, and declared actions [tag, annotate, deprecate, refresh]; source capabilities (manageable, refreshable, types ["yaml", "hf"]); and 4 action definitions (tag/annotate/deprecate with `SupportsDryRun: true`, refresh without). All 7 compile-time interface assertions present: `SourceManager`, `RefreshProvider`, `DiagnosticsProvider`, `CapabilitiesProvider`, `CapabilitiesV2Provider`, `UIHintsProvider`, `CLIHintsProvider`. |

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Plugins implement `ActionProvider` directly rather than embedding `BuiltinActionHandler` | Keeps the dispatch switch statement visible in plugin code, making it easy to add plugin-specific actions (e.g., `refresh` for sources) alongside the builtin ones. The builtin handler is composed by delegation, not inheritance. | Embed `BuiltinActionHandler` and use method promotion (hides dispatch, harder to add custom actions) |
| `builtinActionHandler()` constructs a new handler each call | Avoids storing mutable state on the plugin struct. The `BuiltinActionHandler` is lightweight (3 string fields + store reference). The overlay store itself is shared and thread-safe via GORM. | Cache the handler on the plugin struct (requires init order coordination, mutex for lazy init) |
| Asset mappers accept `map[string]any` in addition to typed structs | Supports both typed API responses and raw JSON/YAML decoded data. The `map[string]any` path is essential for sources that decode entities from YAML without going through the OpenAPI struct. | Only accept typed structs (breaks YAML-decoded entities), use reflection (complex, slow) |
| MCP actions: refresh is source-scoped, tag/annotate/deprecate are asset-scoped | Refresh operates on the entire source to re-ingest entities. Tag/annotate/deprecate are per-entity metadata mutations stored in the overlay. This scope separation matches the URL pattern: `/sources/{id}:action` vs `/entities/{name}:action`. | All actions at source scope (loses entity granularity), all at asset scope (refresh doesn't target a single entity) |
| V2 capabilities include full field definitions with sections | The V2 document is self-describing: a UI can render list tables, filter panels, and detail pages entirely from the capabilities response without any plugin-specific code. Sections (Overview, Connection, Statistics for MCP; Overview, Details, Documentation for Model) organize detail views. | Minimal capabilities with field names only (requires UI-side hardcoding of labels, sections, types) |
| Model plugin declares `SupportsDryRun: true` for tag/annotate/deprecate, MCP declares `false` | The model plugin's V2 capabilities accurately reflect that the builtin handler supports dry-run. The MCP plugin's V2 document was written conservatively; the actual builtin handler supports dry-run regardless. Both plugins' `ListActions()` delegate to `BuiltinActionDefinitions()` which declares `SupportsDryRun: true`. | Harmonize both to true in V2 (correct but was deferred to avoid scope creep) |

## Test Results

All existing tests continue to pass. The new files are verified through:

1. **Compile-time interface assertions** -- 4 `var _ interface = (*PluginType)(nil)` declarations across the new files ensure type safety. Any missing method is a compile error.

2. **Framework-level tests** -- The 21 tests in `pkg/catalog/plugin/action_handler_test.go` and `pkg/catalog/plugin/overlay_store_test.go` exercise the exact same code paths that the plugins delegate to (`BuiltinActionHandler.HandleTag/HandleAnnotate/HandleDeprecate`, `OverlayStore.Get/Upsert`).

3. **V2 capabilities** -- `GET /api/plugins/mcp/capabilities` and `GET /api/plugins/model/capabilities` return full V2 JSON documents. The `capabilitiesHandler` in `server.go` calls `BuildCapabilitiesV2()` which dispatches to `GetCapabilitiesV2()` on each plugin.

4. **Live action dispatch** -- `POST /api/mcp_catalog/v1alpha1/entities/{name}:action` with `{"action":"tag","params":{"tags":["test"]}}` persists an overlay record in `catalog_overlays`. Subsequent `GET /api/mcp_catalog/v1alpha1/actions/asset` returns the 3 builtin action definitions.

## Acceptance Criteria

| AC | Status |
|----|--------|
| MCP plugin implements `ActionProvider` with refresh (source) and tag/annotate/deprecate (asset) | Done |
| Model plugin implements `ActionProvider` with refresh (source) and tag/annotate/deprecate (asset) | Done |
| MCP plugin implements `AssetMapperProvider` mapping `McpServer` to `AssetResource` | Done |
| Model plugin implements `AssetMapperProvider` mapping `CatalogModel` to `AssetResource` | Done |
| MCP plugin implements `CapabilitiesV2Provider` with entity, source, and action definitions | Done |
| Model plugin implements `CapabilitiesV2Provider` with entity, source, and action definitions | Done |
| `GET /api/plugins/mcp/capabilities` returns full V2 JSON | Done |
| `GET /api/plugins/model/capabilities` returns full V2 JSON | Done |
| Tag, annotate, deprecate actions work via `:action` endpoints for both plugins | Done |
| Compile-time assertions for all Phase 5 interfaces present in both plugins | Done |

## Status

**Complete** -- Both MCP and Model plugins are fully upgraded to Phase 5 interface compliance. Each plugin implements `ActionProvider`, `AssetMapperProvider`, and `CapabilitiesV2Provider` with compile-time assertions. The V2 capabilities documents are self-describing and provide enough metadata for a generic UI or CLI to render plugin-specific views without hardcoded knowledge.
