# M6.4: Guardrails and Policies Plugins

**Date**: 2026-02-17
**Status**: Complete
**Phase**: Phase 6 - Core Asset Coverage

## Summary

Added two complementary plugins for AI safety and governance: a Guardrails plugin (10 entries covering NeMo Guardrails, Guardrails AI, regex rules, content filters, and moderation profiles) and a Policies plugin (10 entries covering OPA Rego, YAML/JSON rules, and CEL policies). Both follow the Knowledge plugin in-memory pattern and appear in the generic UI and CLI with zero frontend or CLI code changes.

## Motivation

- Guardrails and policies are essential governance assets in AI systems. Cataloging them enables agents to declaratively reference safety rules and access control policies.
- The Guardrails plugin covers the major industry frameworks (NVIDIA NeMo Guardrails, Guardrails AI) and common patterns (regex rules, content filters).
- The Policies plugin covers OPA/Rego (the de facto standard for policy-as-code), CEL, and simpler YAML/JSON rule formats.
- Both plugins are referenced by the Agents plugin via `guardrailRef` and `policyRef` cross-asset links.

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| **Guardrails Plugin** | |
| `catalog/plugins/guardrails/plugin.go` | `GuardrailPlugin` struct. Entity `GuardrailEntry` with 12 fields (name, guardrailType, enforcementStage, riskCategories, enforcementMode, modalities, configRef, version, author, license). List/get handlers with filterQuery. |
| `catalog/plugins/guardrails/register.go` | `init()` calling `plugin.Register(&GuardrailPlugin{})`. |
| `catalog/plugins/guardrails/management.go` | V2 capabilities: 5 columns, 4 filter fields (name, guardrailType, enforcementStage, enforcementMode - all select-type), 11 detail fields in 3 sections (Overview, Risk Categories, Configuration). 8 compile-time interface assertions. |
| `catalog/plugins/guardrails/actions.go` | `ActionProvider` with source refresh and asset tag/annotate/deprecate. |
| `catalog/plugins/guardrails/asset_mapper.go` | `AssetMapperProvider` mapping `GuardrailEntry` to `AssetResource` with kind `Guardrail`. |
| `catalog/plugins/guardrails/data/sample-guardrails.yaml` | 10 sample guardrails: pii-detector, content-safety-filter, prompt-injection-guard, secrets-scanner, hate-speech-detector, nemo-topical-guard, output-format-validator, toxicity-filter, code-injection-blocker, data-leakage-preventer. |
| **Policies Plugin** | |
| `catalog/plugins/policies/plugin.go` | `PolicyPlugin` struct. Entity `PolicyEntry` with 12 fields (name, policyType, language, bundleRef, entrypoint, enforcementScope, enforcementMode, inputSchema, version, author, license). List/get handlers with filterQuery. |
| `catalog/plugins/policies/register.go` | `init()` calling `plugin.Register(&PolicyPlugin{})`. |
| `catalog/plugins/policies/management.go` | V2 capabilities: 5 columns, 3 filter fields (policyType, language, enforcementScope - all select-type), 12 detail fields in 3 sections (Overview, Bundle, Input Schema). 8 compile-time interface assertions. |
| `catalog/plugins/policies/actions.go` | `ActionProvider` with source refresh and asset tag/annotate/deprecate. |
| `catalog/plugins/policies/asset_mapper.go` | `AssetMapperProvider` mapping `PolicyEntry` to `AssetResource` with kind `Policy`. |
| `catalog/plugins/policies/data/sample-policies.yaml` | 10 sample policies: model-access-control, data-residency, tool-allowlist, model-allowlist, pii-data-governance, safety-rating-threshold, compliance-audit-logging, namespace-resource-quota, agent-permission-boundary, prompt-length-limit. |

### Files Modified

| File | Change |
|------|--------|
| `cmd/catalog-server/main.go` | Added blank imports for guardrails and policies plugins |
| `catalog/config/sources.yaml` | Added `guardrails` and `policies` sections with YAML sources |
| `docker-compose.catalog.yaml` | Added volume mounts for guardrails and policies data directories |

## How It Works

### Guardrails Entity Schema

```go
type GuardrailEntry struct {
    Name             string         `yaml:"name" json:"name"`
    GuardrailType    *string        `yaml:"guardrailType" json:"guardrailType,omitempty"`
    EnforcementStage *string        `yaml:"enforcementStage" json:"enforcementStage,omitempty"`
    RiskCategories   []string       `yaml:"riskCategories" json:"riskCategories,omitempty"`
    EnforcementMode  *string        `yaml:"enforcementMode" json:"enforcementMode,omitempty"`
    Modalities       []string       `yaml:"modalities" json:"modalities,omitempty"`
    ConfigRef        map[string]any `yaml:"configRef" json:"configRef,omitempty"`
}
```

- **Guardrail types**: `nemo_guardrails`, `guardrails_ai`, `regex_rules`, `content_filter`, `moderation_profile`
- **Enforcement stages**: `pre_prompt`, `post_generation`, `tool_use`, `retrieval`, `output_format`
- **Risk categories**: `pii`, `secrets`, `hate`, `violence`, `self_harm`, `malware`, `policy_violation`

### Policies Entity Schema

```go
type PolicyEntry struct {
    Name             string         `yaml:"name" json:"name"`
    PolicyType       *string        `yaml:"policyType" json:"policyType,omitempty"`
    Language         *string        `yaml:"language" json:"language,omitempty"`
    BundleRef        *string        `yaml:"bundleRef" json:"bundleRef,omitempty"`
    Entrypoint       *string        `yaml:"entrypoint" json:"entrypoint,omitempty"`
    EnforcementScope *string        `yaml:"enforcementScope" json:"enforcementScope,omitempty"`
    EnforcementMode  *string        `yaml:"enforcementMode" json:"enforcementMode,omitempty"`
    InputSchema      map[string]any `yaml:"inputSchema" json:"inputSchema,omitempty"`
}
```

- **Policy types**: `access_control`, `data_governance`, `safety`, `tool_allowlist`, `model_allowlist`, `compliance`
- **Languages**: `rego`, `yaml_rules`, `json_rules`, `cel`
- **Enforcement scopes**: `agent`, `organization`, `namespace`, `project`
- **Enforcement modes**: `enforce`, `audit`, `dry-run`

### Filter Coverage

Both plugins use select-type filters for enum fields, enabling the generic UI to render dropdown selectors automatically from the V2 capabilities document.

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| 5 guardrail types covering major frameworks | NeMo Guardrails and Guardrails AI are the two dominant frameworks; regex_rules and content_filter cover common lighter-weight approaches | Fewer types (insufficient coverage of safety landscape) |
| Enforcement stage as a guardrail attribute | Different guardrails apply at different pipeline stages; making this explicit enables stage-aware orchestration | Single enforcement point (too simplistic for real pipelines) |
| OPA/Rego as primary policy language | OPA is the de facto standard for policy-as-code in cloud-native; CEL for Kubernetes-native use cases | Custom policy language (non-standard, poor tooling) |
| `bundleRef` for policy artifact references | OPA bundles are the standard distribution mechanism; enables referencing policy bundles in OCI registries | Inline policy source (doesn't scale, security concerns) |
| Separate plugins (not combined) | Guardrails (safety/content rules) and policies (governance/access control) serve different stakeholder concerns | Combined "safety" plugin (conflates different governance domains) |

## Testing

- Both plugins follow the Knowledge plugin pattern, validated through the conformance suite
- Manual verification: both appear in UI with proper filter dropdowns (select-type for all enum fields)
- Run: `go vet ./catalog/plugins/guardrails/... ./catalog/plugins/policies/...`

## Verification

```bash
# Verify both plugins compile
go vet ./catalog/plugins/guardrails/... ./catalog/plugins/policies/...

# With catalog server running:
# Guardrails
curl -s http://localhost:8080/api/guardrails_catalog/v1alpha1/guardrails | python3 -m json.tool
curl -s http://localhost:8080/api/guardrails_catalog/v1alpha1/guardrails/pii-detector | python3 -m json.tool

# Policies
curl -s http://localhost:8080/api/policies_catalog/v1alpha1/policies | python3 -m json.tool
curl -s http://localhost:8080/api/policies_catalog/v1alpha1/policies/model-access-control | python3 -m json.tool

# Filter test
curl -s "http://localhost:8080/api/guardrails_catalog/v1alpha1/guardrails?filterQuery=enforcementMode%3D'required'" | python3 -m json.tool
```

## Dependencies & Impact

- **Enables**: M6.6 (stack assembly), cross-asset linking from Agents plugin
- **Depends on**: M6.1 (stack preparation), Phase 5 framework
- **Referenced by**: Agents plugin via `guardrailRef` and `policyRef` cross-asset links
- **Backward compatibility**: No changes to existing plugins or UI/CLI code

## Open Items

- Policy evaluation/enforcement engine (out of scope; catalog is discovery-only)
- Guardrail integration testing with actual NeMo Guardrails or Guardrails AI runtimes (future work)
- OCI bundle resolution for `bundleRef` (requires OCI provider, deferred)
