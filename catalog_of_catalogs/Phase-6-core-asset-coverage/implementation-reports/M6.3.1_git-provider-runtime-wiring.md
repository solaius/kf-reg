# M6.3.1: Git Provider Runtime Wiring in Agents Plugin

**Date**: 2026-02-17
**Status**: Complete
**Phase**: Phase 6 - Core Asset Coverage

## Summary

Wired the Git provider (built in M6.1) into the Agents plugin at runtime, enabling agents to be loaded from Git repositories alongside YAML files. This closes the Phase 6 exit criterion for "2+ provider types beyond YAML exercised." The Agents plugin now loads 12 agents total (10 from YAML, 2 from a bare Git repo) with full UI rendering and background sync support.

## Motivation

- The Git provider was built in M6.1 and the Agents plugin declared `git` as a supported source type in its capabilities, but `Init()` only handled `yaml` sources — the git path was dead code.
- The Phase 6 exit criterion "2+ provider types beyond YAML exercised" was only partially met until this wiring was completed.
- Code review feedback explicitly identified this gap: "wire Agents to load from Git provider in runtime and demo at least one agents catalog from a Git repo."

## What Changed

### Files Modified

| File | Change |
|------|--------|
| `catalog/plugins/agents/plugin.go` | Added `gitCancels` field to `AgentPlugin` struct. Updated `Init()` to dispatch on `src.Type` for `yaml` and `git`. Updated `Stop()` to cancel git provider goroutines. Added `loadGitSource()`, `parseAgentRecords()`, and `slogGitLogger` adapter. |
| `catalog/plugins/agents/management.go` | Updated `Refresh()` and `RefreshAll()` to dispatch via new `refreshSource()` method that handles both yaml and git source types. `refreshSource()` cancels previous git provider goroutine before creating a new one. |
| `catalog/config/sources.yaml` | Added `agents-git` source entry (type: git, enabled: true) pointing to `file:///sample-repos/agents-repo`. |
| `docker-compose.catalog.yaml` | Added volume mount `./catalog/sample-repos/agents-repo:/sample-repos/agents-repo:ro` for the bare git repo. |
| `Dockerfile.catalog-server` | Changed runtime base from `gcr.io/distroless/static:nonroot` to `alpine:3.21` with `git` and `ca-certificates` installed. Required because `go-git` shells out to `git` for local filesystem transport (`file://` URLs). Added `git config --system --add safe.directory '*'` to handle mounted repo ownership. |

### Files Created

| File | Purpose |
|------|---------|
| `catalog/sample-repos/agents-repo/` | Bare git repo containing 2 sample research agents (`literature-review-agent`, `experiment-tracker`) for Git provider testing. |

## How It Works

### Plugin-to-Provider Bridge

The `loadGitSource()` function bridges the plugin config layer (`plugin.SourceConfig`) to the git provider layer (`catalog.Source`):

```go
func loadGitSource(ctx context.Context, src plugin.SourceConfig, logger *slog.Logger) ([]AgentEntry, context.CancelFunc, error) {
    // Convert plugin.SourceConfig to catalog.Source for the git provider.
    catalogSource := &catalog.Source{
        ID: src.ID, Name: src.Name, Type: src.Type,
        Properties: src.Properties, Origin: src.Origin,
    }

    gitCfg := gitprovider.Config[AgentEntry, any]{
        Parse:  parseAgentRecords,
        Logger: &slogGitLogger{logger: logger},
    }

    provider, err := gitprovider.NewProvider(gitCfg, catalogSource, "")
    // ... clone, drain initial batch, return entries + cancel func
}
```

### Init Dispatch

```go
switch src.Type {
case "yaml":
    entries, err := loadYAMLSource(src)
    // ...
case "git":
    entries, cancel, err := loadGitSource(ctx, src, p.logger)
    // ... store entries and cancel func in p.gitCancels
}
```

### Refresh Dispatch

Both `Refresh()` and `RefreshAll()` use a shared `refreshSource()` method that handles lifecycle management for git providers:

```go
func (p *AgentPlugin) refreshSource(ctx context.Context, src plugin.SourceConfig) ([]AgentEntry, error) {
    switch src.Type {
    case "yaml":
        return loadYAMLSource(src)
    case "git":
        // Cancel previous git provider goroutine if one exists.
        if cancel, ok := p.gitCancels[src.ID]; ok {
            cancel()
            delete(p.gitCancels, src.ID)
        }
        entries, cancel, err := loadGitSource(ctx, src, p.logger)
        if err != nil {
            return nil, err
        }
        if cancel != nil {
            p.gitCancels[src.ID] = cancel
        }
        return entries, nil
    default:
        return nil, fmt.Errorf("unsupported source type %q", src.Type)
    }
}
```

### Background Sync Lifecycle

Each git source gets a cancellable context. The git provider's `watchAndReload` goroutine periodically pulls and re-emits records if HEAD changes. On `Stop()` or `Refresh()`, the old goroutine is canceled before creating a new one:

```go
func (p *AgentPlugin) Stop(ctx context.Context) error {
    for id, cancel := range p.gitCancels {
        p.logger.Info("canceling git provider", "source", id)
        cancel()
    }
    p.gitCancels = nil
    // ...
}
```

### Docker Setup

The bare git repo is mounted read-only into the container and accessed via `file://` protocol:

```yaml
# docker-compose.catalog.yaml
volumes:
  - ./catalog/sample-repos/agents-repo:/sample-repos/agents-repo:ro

# sources.yaml
- id: agents-git
  type: git
  enabled: true
  properties:
    repoUrl: "file:///sample-repos/agents-repo"
    branch: "main"
    path: "**/*.yaml"
    syncInterval: "1h"
```

### Dockerfile Base Image Change

The `go-git` library uses the `git` binary for `file://` protocol transport. The distroless base image has no binaries, so the runtime was switched to Alpine:

```dockerfile
FROM alpine:3.21
RUN apk add --no-cache git ca-certificates && \
    adduser -D -u 65532 nonroot && \
    mkdir -p /home/nonroot && \
    git config --system --add safe.directory '*'
```

The `safe.directory '*'` config is required because mounted volumes have different ownership than the container user.

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Bridge `plugin.SourceConfig` → `catalog.Source` in `loadGitSource()` | Plugin layer uses `plugin.SourceConfig`; git provider uses `catalog.Source`; bridge keeps the conversion localized | Changing the git provider to accept `plugin.SourceConfig` (couples provider to plugin framework) |
| Cancel-and-recreate on refresh | Git provider goroutines hold temp directory references; cleanest to cancel old, create new | Reuse provider instance (complex state management, no clear API for re-clone) |
| Alpine base instead of distroless | `go-git` requires `git` binary for `file://` transport; Alpine is minimal (~7MB) with package manager | Installing git into distroless (not supported), using HTTP transport only (limits local testing) |
| `safe.directory '*'` | Mounted volumes have host-side ownership; git refuses to operate without this | `chown` in entrypoint (fragile), running as root (security concern) |
| Bare repo for testing | Standard git hosting format; can be mounted read-only; works with `go-git` clone | Non-bare repo (unnecessary working tree), remote URL only (requires network in CI) |

## Testing

- **Compilation**: `go vet ./catalog/plugins/agents/...` and `go build ./catalog/plugins/agents/...` pass
- **Docker stack**: All 8 plugins healthy via `/readyz`
- **API verification**: `GET /api/agents_catalog/v1alpha1/agents` returns 12 agents (10 YAML + 2 Git)
- **UI verification**: Playwright-based browser testing confirmed all 12 agents render in list view; git-sourced `literature-review-agent` detail view shows all 7 sections with cross-asset references

## Verification

```bash
# Build and start the stack
docker compose -f docker-compose.catalog.yaml up --build -d

# Wait for readiness
curl -s http://localhost:8080/readyz | python3 -m json.tool

# Verify 12 agents from both sources
curl -s http://localhost:8080/api/agents_catalog/v1alpha1/agents | \
  python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Total: {d[\"size\"]}'); [print(f'  {a[\"name\"]:30s} source={a.get(\"sourceId\")}') for a in d['items']]"

# Verify git-sourced agent detail
curl -s http://localhost:8080/api/agents_catalog/v1alpha1/agents/literature-review-agent | python3 -m json.tool

# Check container logs for git clone confirmation
docker logs catalog-server 2>&1 | grep "loaded agents from git"
# Expected: entries=2 commit=<sha>
```

## Dependencies & Impact

- **Depends on**: M6.1 (Git provider at `pkg/catalog/providers/git/`), M6.3 (Agents plugin)
- **Closes**: Phase 6 exit criterion "2+ provider types beyond YAML exercised"
- **Enables**: Production git-backed agent catalogs; pattern for wiring git into other plugins
- **Impact on Dockerfile**: Runtime base changed from distroless to Alpine; image size increases slightly (~7MB for git + ca-certificates) but enables git provider functionality

## Open Items

- Wire git provider into other plugins (Prompts, Skills, etc.) following same pattern if needed
- HTTP/HTTPS git source testing with actual remote repositories (e.g., GitHub)
- Auth token support validation for private repos (mechanism exists in git provider, not yet tested end-to-end)
