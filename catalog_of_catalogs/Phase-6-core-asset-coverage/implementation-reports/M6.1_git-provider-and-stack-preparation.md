# M6.1: Git Provider and Stack Preparation

**Date**: 2026-02-17
**Status**: Complete
**Phase**: Phase 6 - Core Asset Coverage

## Summary

Built a Git repository-based data provider for loading catalog data from Git repos, and prepared the Docker stack and sources configuration for the 5 new Phase 6 plugins. The Git provider uses `go-git` (pure Go) for cloning, branch selection, glob-based file discovery, commit SHA tracking for provenance, and periodic sync with hot-reload.

## Motivation

- Phase 6 requires 2+ provider types beyond YAML to meet exit criteria. Git is the most natural fit for team-managed catalog YAML files.
- The Docker stack and `sources.yaml` need placeholder sections for all new plugins before they can be integrated.
- Git provider enables production-ready catalog management where teams maintain asset definitions in version-controlled repositories.

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/providers/git/provider.go` | Generic Git provider implementation using `go-git/v5`. Clones repos, walks path globs, parses YAML via caller-supplied `Parse` callback, tracks commit SHA for provenance, supports shallow clone, auth tokens, and periodic sync. |
| `pkg/catalog/providers/git/provider_test.go` | 9 unit tests covering: NewProvider validation, missing URL, defaults, clone-and-read, Records channel, matchGlob (12 sub-cases), filter callback, shallow clone config, and custom sync interval. |
| `catalog/sample-repos/agents/research-agents.yaml` | 2 sample agent entries for CI-reproducible Git provider testing with in-repo data. |

### Files Modified

| File | Change |
|------|--------|
| `go.mod` | Added `github.com/go-git/go-git/v5` dependency |
| `go.sum` | Updated with `go-git` transitive dependencies |
| `catalog/config/sources.yaml` | Added placeholder sections for prompts, agents, guardrails, policies, skills plugins |
| `docker-compose.catalog.yaml` | Added volume mounts for all 5 new plugin data directories |
| `cmd/catalog-server/main.go` | Added blank imports for all 5 new plugins |

## How It Works

### Git Provider

The provider is generic over entity and artifact types using Go generics:

```go
type Config[E any, A any] struct {
    Parse        func(data []byte) ([]catalog.Record[E, A], error)
    Filter       func(record catalog.Record[E, A]) bool
    DefaultBranch string
    ShallowClone  *bool
}

type Provider[E any, A any] struct {
    repoURL, branch, pathPattern string
    syncInterval time.Duration
    shallowClone bool
}
```

The lifecycle is:
1. `NewProvider()` reads source properties (`repoUrl`, `branch`, `path`, `authToken`, `syncInterval`, `shallowClone`) with sensible defaults
2. `Records()` clones the repo, reads files matching the glob pattern, parses via the `Parse` callback, and emits records on a channel
3. A background goroutine periodically pulls and re-emits if HEAD changed
4. `LastCommit()` returns the current SHA for provenance tracking

### Glob Matching

Supports `**` (recursive directory match), `*` (single-level wildcard), and `?` (single character):

```go
func matchGlob(pattern, path string) bool {
    if strings.Contains(pattern, "**") {
        // Split on **, match prefix, then try suffix against all subpaths
    }
    matched, _ := filepath.Match(pattern, path)
    return matched
}
```

### Source Properties Schema

```yaml
type: git
properties:
  repoUrl: "https://github.com/org/repo.git"
  branch: "main"              # default: main
  path: "agents/**/*.yaml"    # glob pattern
  authToken: ""               # optional, or SecretRef
  shallowClone: true          # default: true
  syncInterval: "1h"          # default: 1h
```

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Pure Go `go-git` library | No external `git` binary dependency, works in distroless containers | Shell out to `git` CLI (requires git binary in image) |
| Shallow clone by default | Minimizes clone time and disk for large repos | Full clone (unnecessary for YAML catalog files) |
| Generic `Parse` callback | Provider is reusable across all entity types without coupling | Hardcoded entity parsing (would require per-type providers) |
| In-repo sample data at `catalog/sample-repos/` | CI-reproducible Git provider testing without external dependencies | External test repo (flaky, requires network) |
| Periodic sync via ticker | Simple, predictable polling; webhook support deferred | Webhooks (complex, requires ingress configuration) |

## Testing

- **9 unit tests** in `pkg/catalog/providers/git/provider_test.go`
- Tests create temporary bare Git repos using `go-git/v5`'s `PlainInitWithOptions` with `DefaultBranch: refs/heads/main`
- Covers: provider creation, validation, clone-and-read, glob matching (12 sub-cases including `**/*.yaml`, nested paths, exact matches), filter callbacks, configuration defaults and overrides
- Run: `go test ./pkg/catalog/providers/git/... -v`

## Verification

```bash
# Run Git provider unit tests
go test ./pkg/catalog/providers/git/... -v -count=1

# Verify Docker stack builds with new volume mounts
docker compose -f docker-compose.catalog.yaml build

# Verify sources.yaml has all plugin sections
grep -c "sources:" catalog/config/sources.yaml  # expect 8

# Verify main.go imports all plugins
grep -c 'catalog/plugins' cmd/catalog-server/main.go  # expect 8
```

## Dependencies & Impact

- **Enables**: M6.3 (Agents plugin Git wiring), M6.6 (stack assembly)
- **Depends on**: Phase 5 catalog framework (`pkg/catalog/` types)
- **Backward compatibility**: No changes to existing providers or plugins. New dependency (`go-git`) is additive only.

## Open Items

- Webhook-triggered sync (deferred; periodic polling sufficient for current needs)
- OCI artifact provider (deferred to Phase 6.5 per plan)
- Git provider integration tests with real remote repos (unit tests use local bare repos)
