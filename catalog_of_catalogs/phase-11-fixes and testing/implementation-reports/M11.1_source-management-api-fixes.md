# M11.1 Source Management API Fixes

**Date**: 2026-02-19
**Status**: Complete
**Commit**: `178e6709` on branch `plugin-catalog-gen`

## Summary

Fixed three categories of bugs in the catalog source management flow that caused the UI to display generic server errors when toggling source visibility, saving source configurations, and refreshing sources.

## Problems Identified

### Bug 1: Enable/Disable Toggle Fails with Server Error

**Symptom**: Clicking the "Visible in catalog" toggle on any plugin's sources page produced:
> "Failed to toggle source: the server encountered a problem and could not process your request"

**Root Cause**: The catalog server's `enableHandler` (`pkg/catalog/plugin/management_handlers.go`) returned `{"status":"updated","enabled":true}` but the BFF's `EnablePluginSource` repository method (`clients/ui/bff/internal/repositories/catalog_management.go`) expected a `SourceInfo` object. The JSON unmarshal failure propagated as a 500 to the frontend.

### Bug 2: Entities Not Reloading After Re-Enable

**Symptom**: After disabling a source (entities disappear) and re-enabling it, entities remained at 0 and did not appear in the catalog.

**Root Cause**: The `EnableSource` method in all 6 in-memory plugins (agents, prompts, skills, policies, guardrails, knowledge) only handled the disable path by deleting entities from the in-memory map. The enable path was a no-op: it neither updated the config's `Enabled` flag nor reloaded entities from the source.

### Bug 3: Save Source Configuration Fails

**Symptom**: Clicking "Save" on the manage source page produced:
> "Error saving source: the server encountered a problem and could not process your request"

**Root Cause**: Same pattern as Bug 1. The `applyHandler` returned `{"status":"applied"}` (an `ApplyResult`) but the BFF expected a `SourceInfo` object.

### Bug 4: Refresh All Sources Fails

**Symptom**: Clicking "Refresh all sources" on any plugin's sources page produced:
> "Refresh failed:"

**Root Cause**: Two issues compounded:
1. The catalog server's async refresh handlers return HTTP 202 Accepted (with `{"status":"queued","jobId":"..."}`) when the job store is enabled (the default). The BFF's HTTP client only accepted 200 and 201 as success codes, treating 202 as an error.
2. On Windows, `SetupEnvTest` in the BFF called `os.Exit(1)` when envtest binaries were unavailable, preventing the fallback to a fake K8s clientset from executing.

## Fixes Applied

### 1. Server Response Format Alignment

**Files**: `pkg/catalog/plugin/management_handlers.go`

- `enableHandler`: Now calls `sm.ListSources()` after a successful enable/disable and returns the full `SourceInfo` for the affected source. Falls back to a minimal `SourceInfo{ID, Enabled}` if ListSources fails.
- `applyHandler`: Same pattern â€” returns the updated `SourceInfo` after a successful apply instead of `ApplyResult`.

### 2. EnableSource Implementation in 6 In-Memory Plugins

**Files**:
- `catalog/plugins/agents/management.go`
- `catalog/plugins/prompts/management.go`
- `catalog/plugins/skills/management.go`
- `catalog/plugins/policies/management.go`
- `catalog/plugins/guardrails/management.go`
- `catalog/plugins/knowledge/management.go`

Each plugin's `EnableSource` now:
1. Updates `p.cfg.Section.Sources[i].Enabled` so `ListSources` reflects the correct state
2. On disable (`enabled=false`): clears entities from the in-memory map
3. On enable (`enabled=true`): reloads entities by calling `loadYAMLSource` (or `refreshSource` for agents, which also supports git)
4. Returns `"source not found"` error if the source ID doesn't exist in config

### 3. BFF HTTP Client: Accept 202 Accepted

**File**: `clients/ui/bff/internal/integrations/httpclient/http.go`

Added `http.StatusAccepted` (202) to the success status check so async job responses from the catalog server pass through correctly.

### 4. BFF envtest Graceful Fallback

**File**: `clients/ui/bff/internal/integrations/kubernetes/k8mocks/base_testenv.go`

Changed `SetupEnvTest` to return an error instead of calling `os.Exit(1)` when envtest binaries are unavailable. This allows the caller in `app.go` to fall through to the fake clientset fallback, which is essential for Windows development.

## Test Updates

**Files**:
- `pkg/catalog/plugin/management_handlers_test.go`
- `pkg/catalog/plugin/refresh_status_test.go`

Updated test assertions to match the new `SourceInfo` response format:
- `TestEnableHandler`: Now sets up sources in the mock plugin and asserts on `SourceInfo` fields
- `TestApplyHandler_ValidationRejects` (valid input case): Asserts `SourceInfo.ID` instead of `ApplyResult.Status`
- `TestApplyHandler_ResolvesSecretRefs`: Asserts `SourceInfo.ID` instead of `ApplyResult.Status`
- `TestApplyHandler_RefreshAfterApply_PersistsStatus`: Asserts `SourceInfo.ID` instead of `ApplyResult.Status`

## Contrast with MCP and Model Plugins

The MCP and Model plugins were not affected by Bug 2 because they use a `loader.Sources.Merge()` pattern that properly toggles the `Enabled` flag on the source object without destroying entities. The 6 newer in-memory plugins used a simpler `map[string][]Entry` pattern that required explicit reload logic.

## Verification

- All management handler tests pass: `go test ./pkg/catalog/plugin/... -run "TestEnable|TestSourcesList|TestDelete|TestApply|TestValidate|TestRefresh"`
- All 6 plugin packages compile cleanly: `go build ./catalog/plugins/...`
- BFF compiles cleanly: `cd clients/ui/bff && go build ./...`
- Docker stack rebuilt and verified: all 8 plugins healthy via `/readyz`
- Manual UI verification: toggle, save, and refresh all work on agents and MCP sources pages
