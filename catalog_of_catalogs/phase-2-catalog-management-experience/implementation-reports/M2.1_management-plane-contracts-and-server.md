# M2.1: Management Plane Contracts and Server Implementation

**Date**: 2026-02-15
**Status**: Complete
**Phase**: Phase 2: Catalog Management Experience

## Summary

This milestone delivered the core management plane: Go interfaces and types for source management, RBAC middleware, HTTP handlers with chi router, and concrete implementations in both the MCP and Model plugins. Together these provide a full CRUD + refresh + diagnostics API for all catalog plugins, discoverable at runtime via type assertion on optional interfaces.

## Motivation

- The catalog server could load and serve entities but had no API for operators to manage sources, trigger refreshes, or inspect diagnostics at runtime (addresses **B1-B4**, **C1-C3**).
- Management endpoints need role-based access control so viewers can browse but only operators can mutate sources (addresses **D1**, **D2**).
- The management contract must be plugin-agnostic so new asset-type plugins get management APIs automatically (addresses **E1**).

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/plugin/management_types.go` | Type definitions: `SourceInfo`, `SourceStatus`, `SourceConfigInput`, `ValidationResult`, `RefreshResult`, `PluginDiagnostics`, `UIHints`, `CLIHints` |
| `pkg/catalog/plugin/rbac.go` | RBAC middleware: `Role` enum, `RoleExtractor`, `RequireRole()` middleware, `DefaultRoleExtractor` |
| `pkg/catalog/plugin/management_handlers.go` | HTTP handlers: `managementRouter()`, source CRUD, refresh, diagnostics handlers |
| `catalog/plugins/mcp/management.go` | MCP plugin: implements `SourceManager`, `RefreshProvider`, `DiagnosticsProvider`, `UIHintsProvider`, `CLIHintsProvider` |
| `catalog/plugins/model/management.go` | Model plugin: implements same 5 interfaces for the model catalog |

### Files Modified

| File | Change |
|------|--------|
| `pkg/catalog/plugin/plugin.go` | Added 5 optional management interfaces: `SourceManager`, `RefreshProvider`, `DiagnosticsProvider`, `UIHintsProvider`, `CLIHintsProvider` |
| `pkg/catalog/plugin/server.go` | Added `ServerOption` functional options, `WithRoleExtractor`, `roleExtractor` field; `MountRoutes` mounts `managementRouter` when plugin implements management interfaces; `pluginsHandler` includes management/uiHints/cliHints in response |
| `pkg/catalog/loader.go` | Added `Config()` accessor to expose `LoaderConfig` (needed by plugins to access `ProviderRegistry` for validation) |
| `catalog/internal/catalog/loader.go` | Added public `Reload()` method (wraps private `reloadAll`) for on-demand refresh |

## How It Works

### Optional Management Interfaces

Plugins opt in to management capabilities by implementing any combination of these interfaces. The server detects them via type assertion at mount time:

```go
type SourceManager interface {
    ListSources(ctx context.Context) ([]SourceInfo, error)
    ValidateSource(ctx context.Context, src SourceConfigInput) (*ValidationResult, error)
    ApplySource(ctx context.Context, src SourceConfigInput) error
    EnableSource(ctx context.Context, id string, enabled bool) error
    DeleteSource(ctx context.Context, id string) error
}

type RefreshProvider interface {
    Refresh(ctx context.Context, sourceID string) (*RefreshResult, error)
    RefreshAll(ctx context.Context) (*RefreshResult, error)
}

type DiagnosticsProvider interface {
    Diagnostics(ctx context.Context) (*PluginDiagnostics, error)
}
```

### RBAC Middleware

Role enforcement uses a pluggable `RoleExtractor` function (defaults to reading `X-User-Role` header). Write operations require `RoleOperator`; read operations are available to `RoleViewer`:

```go
func RequireRole(role Role, extractor RoleExtractor) func(http.Handler) http.Handler
```

### Management Router

Routes are mounted as sub-paths under each plugin's existing base path. The router only registers routes for interfaces the plugin actually implements:

| Method | Path | Required Interface | Min Role |
|--------|------|--------------------|----------|
| GET | `/sources` | SourceManager | viewer |
| POST | `/validate-source` | SourceManager | operator |
| POST | `/apply-source` | SourceManager | operator |
| POST | `/sources/{sourceId}/enable` | SourceManager | operator |
| DELETE | `/sources/{sourceId}` | SourceManager | operator |
| POST | `/refresh` | RefreshProvider | operator |
| POST | `/refresh/{sourceId}` | RefreshProvider | operator |
| GET | `/diagnostics` | DiagnosticsProvider | viewer |

### Plugin Implementations

Both MCP and Model plugins implement all management interfaces in separate `management.go` files (avoiding edits to code-generated `plugin.go`). They delegate to the generic loader infrastructure:

- **ListSources**: reads from `loader.Sources.AllSources()` and maps to `SourceInfo`
- **Refresh**: calls `loader.Reload(ctx)` for full reload
- **DeleteSource**: removes entities via repository then removes the source config
- **Diagnostics**: aggregates source states, entity counts, and error history

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Optional interfaces via type assertion | Zero-cost for plugins that don't implement management; no breaking changes to `CatalogPlugin` interface | Single fat interface with no-op defaults |
| Separate `management.go` files per plugin | Avoids modifying code-generated `plugin.go` files | Embedding management logic in generated code |
| `validate-source` / `apply-source` paths (not under `/sources/`) | Avoids httprouter wildcard conflicts with `/sources/{sourceId}` in the BFF | Nested `/sources/validate` (caused httprouter panic) |
| Role-based middleware, not attribute-based | Simple, fits the two-role model (viewer/operator) specified in requirements | Full ABAC with policy engine |
| `DefaultRoleExtractor` reads header | Works behind reverse proxies and auth gateways that inject role headers | JWT claim extraction (more complex, deployment-specific) |

## Testing

- `pkg/catalog/plugin/rbac_test.go` - 11 test cases covering role extraction, middleware enforcement, missing headers, case sensitivity
- `pkg/catalog/plugin/management_handlers_test.go` - 10 test cases covering sources list, validate (valid/invalid), refresh all, refresh per-source, diagnostics, enable, delete, and RBAC enforcement on management router

Run:
```bash
cd pkg/catalog/plugin && go test -v -run "TestRequireRole|TestDefaultRoleExtractor|TestSources|TestValidate|TestRefresh|TestDiagnostics|TestEnable|TestDelete|TestManagement"
```

## Verification

```bash
# Build catalog server
go build ./cmd/proxy

# Run tests
go test ./pkg/catalog/plugin/... -v

# Start server (if catalog DB is available)
go run ./cmd/proxy --catalog-sources-config=config/catalog-sources.yaml

# List plugins (includes management capabilities)
curl http://localhost:8081/api/plugins | jq

# List sources for a plugin
curl http://localhost:8081/api/model_catalog/v1/sources | jq

# Trigger refresh (requires operator role)
curl -X POST -H "X-User-Role: operator" http://localhost:8081/api/model_catalog/v1/refresh | jq

# Get diagnostics
curl http://localhost:8081/api/model_catalog/v1/diagnostics | jq
```

## Dependencies & Impact

- **Depends on**: Phase 1 plugin framework (M1 hardening, M2 MCP plugin)
- **Enables**: M2.2 (CLI), M2.3 (BFF + UI), M2.4 (extensibility patterns)
- **Backward compatible**: No changes to existing entity list/get/artifacts endpoints

## Open Items

- Source config persistence: current implementations modify in-memory config only; file-based persistence (write-back to ConfigMap or YAML) is deferred
- Partial refresh (single source reload without reloading all) depends on loader refactoring
- Rate limiting on refresh endpoints is not yet implemented
