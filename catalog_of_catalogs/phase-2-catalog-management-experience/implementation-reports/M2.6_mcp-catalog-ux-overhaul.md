# M2.6: MCP Catalog UX Overhaul & Management

## Summary

Phase 2.6 overhauled the MCP Catalog UI and Catalog Management experience to match
RHOAI 3.4 patterns and deliver a fully functional plugin-based management interface.
All changes follow PatternFly v6 conventions and the existing plugin architecture.

## Milestones Completed

### Milestone 1: BFF Mock Data & Source Page Data Flow

**Problem:** The BFF `SourceInfo` model used a flat `Status string` field, but the frontend
`SourceStatus` type expected a nested object `{ state, entityCount, lastRefreshTime, error }`.
This caused broken status columns and missing entity counts.

**Fix:**
- Updated `SourceInfo.Status` from `string` to nested `SourceStatus` struct in
  `clients/ui/bff/internal/models/catalog_management.go`
- Updated mock `GetPluginSources()` to return plugin-specific sources with nested status:
  - **MCP plugin**: 2 sources (MCP YAML Source, Community Servers)
  - **Model plugin**: 7 sources matching Model Catalog Settings (Sample mocked source,
    Hugging Face, Admin model 1/2/3, Dora source, No Performance Data Source)

### Milestone 2: Plugin Sources Page Redesign

**Problem:** The plugin management pages showed placeholder data with broken columns.
The UI lacked the management features users expected.

**Fix:** Rewrote `PluginSourcesPage.tsx` with:
- Toolbar with "+ Add a source" (PlusCircleIcon) and "Refresh all sources" (SyncIcon) buttons
- Table columns: Source name, Source type (display labels), Visible in catalog (Switch toggle),
  Status (colored Label), Entities, Manage source (link), Actions (ActionsColumn kebab)
- Kebab menu items: "Manage source", "View in catalog", separator, "Delete source"
- Delete confirmation modal using shared `DeleteModal` component
- Plugin-aware "View in catalog" navigation (model → /model-catalog, mcp → /mcp-catalog)

**Add/Manage Source Form** (`PluginSourceConfigPage.tsx`):
- Standalone page (not nested inside plugin tabs) with proper breadcrumbs
- Dual-purpose: Add mode (empty form) and Manage mode (pre-filled from existing source)
- Sidebar layout matching RHOAI 3.4 ManageSourceForm pattern:
  - Left side: Form with Source name, Source type (radio), FileUpload (drag-and-drop YAML), Visible in catalog (checkbox)
  - Right side: Preview panel with EmptyState and CubesIcon
- Plugin-specific labels (model → "Model catalog", mcp → "MCP catalog")
- Model plugin shows both "YAML file" and "Hugging Face" radio options
- FileUpload component with drag-and-drop `.yaml`/`.yml` support and inline text editing
- Manage mode loads existing YAML content from `source.properties.content`
- Sticky footer with ActionList (Add/Save + Cancel buttons)
- Routes: `/plugin/:name/sources/add` and `/plugin/:name/sources/:sourceId/manage`

### Milestone 3: MCP Server Detail Page Redesign

**Problem:** The MCP detail page was a basic flat DescriptionList.

**Fix:** Redesigned with two-column Grid layout:
- **Left column** (span 8):
  - Description Card with full server description
  - Tools Card with search/filter, pagination (5 per page), expandable tool cards
    with access type badges (Read Only/green, Read/Write/orange, Destructive/red)
    and parameter tables
  - README Card with markdown rendering (headers, bold, italic, code, lists, links)
- **Right column** (span 4): Server Details sidebar with Tags, License, Version,
  Deployment Mode, Image (ClipboardCopy), Endpoint, Source Code (external link),
  Provider, Transport, Last Modified

**New components:**
- `McpToolCard.tsx` - Expandable tool display with access badges and parameter table
- `McpReadme.tsx` - Simple markdown renderer
- `McpServerDetailsSidebar.tsx` - Metadata sidebar with DescriptionList

### Milestone 4: MCP Gallery Page Upgrade

**Problem:** Gallery had hardcoded filters, no category tabs, no active filter chips.
The search input and tab structure didn't match Model Catalog look and feel.

**Fix (Round 1):**
- Added `ToggleGroup` category tabs derived from server categories
- Dynamic filters derived from loaded server data (Deployment Mode, Category, License, Transport)
- Filter sections with search-within-filter and show more/less (5 visible threshold)
- Active filter chips with removable labels and "Clear all filters"

**Fix (Round 2 - Match Model Catalog Patterns):**
- Replaced `SearchInput` with `ThemeAwareSearchInput` matching `ModelCatalogSourceLabelSelector.tsx`:
  - Field label "Filter by name, description and provider"
  - `ArrowRightIcon` submit button for MUI theme
  - `ToolbarToggleGroup` with `FilterIcon` toggle
  - Live search (filters on keystroke) for responsive UX
- Replaced category-based tabs with **source-label-based** `ToggleGroup` tabs
  matching `ModelCatalogSourceLabelBlocks.tsx` pattern:
  - Tabs derived from `availableFilterValues.sourceLabels` (e.g., "All servers",
    "MCP YAML Source servers", "Community Servers servers")
  - "Other servers" tab for servers without a source label
  - Old hardcoded tabs ("Red Hat servers", "Database servers", etc.) removed
- Replaced `LabelGroup`/`Label` filter chips with `ToolbarFilter` components
  matching `ModelCatalogActiveFilters.tsx` pattern:
  - Category-grouped removable chips with `deleteLabel`/`deleteLabelGroup`
  - `clearAllFilters` on Toolbar with "Reset all filters" button text
- Layout restructured with `Stack`/`StackItem`: search toolbar → source label tabs → sidebar with filters + gallery
- Added `sourceLabel` field to `McpServer` model (Go + TypeScript) for source-based categorization
- Added `sourceLabels` to `McpCatalogContext.availableFilterValues`
- Context filtering updated from `s.category` to `s.sourceLabel` for tab selection
- Added `MCP_OTHER_SERVERS` sentinel constant for servers without labels

### Milestone 5: Plugin Architecture Fixes

**Problem:** Frontend checked `selectedPlugin.management?.sourceManager` to conditionally
render management UI, but BFF `CatalogPlugin` model lacked the `Management` field.

**Fixes:**
- Added `CatalogPluginManagement` struct to `catalog_plugin.go`
- Added `Management` field to `CatalogPlugin` struct
- Updated mock data to include management capabilities for both plugins
- Fixed `PluginSourceConfigPage` to work standalone (uses `pluginName` from URL params
  instead of relying on `selectedPlugin` from context)
- Moved add/manage source routes outside `PluginDetailPage` nesting

### Milestone 6: Model Plugin Source Management Redirect

**Problem:** Model plugin add/manage source pages used the generic `PluginSourceConfigPage`
(simple YAML upload form), but the existing Model Catalog Settings pages at
`/model-catalog-settings/add-source` and `/model-catalog-settings/manage-source/:id`
have a richer form with `SourceDetailsSection`, `CredentialsSection`, `YamlSection`,
`ModelVisibilitySection`, and `PreviewPanel`.

**Fix:**
- Updated `PluginSourcesPage.tsx` to detect `isModelPlugin` (when `selectedPlugin.name === 'model'`)
- Model plugin navigation redirects:
  - "+ Add a source" → `/model-catalog-settings/add-source`
  - "Manage source" → `/model-catalog-settings/manage-source/:sourceId`
- MCP plugin continues using the generic `PluginSourceConfigPage`
- All three navigation points updated: Add button, Manage link, Kebab menu

### Milestone 7: Source ID Alignment & Stateful Mock

**Problem 1:** Model plugin sources used IDs like `sample-source` and `huggingface` in the
plugin management mock, but the Model Catalog Settings mock expected IDs like
`sample_source_models` and `hugging_face_source`. Clicking "Manage source" on a model source
resulted in a loading animation because the settings page couldn't find the source config.

**Fix:** Aligned model source IDs in plugin management mock to match settings IDs:
`bella_ai_validated_models`, `custom_yaml_models`, `dora_ai_models`, `hugging_face_source`,
`sample_source_models`, `admin_models_1`, `admin_models_2`.

**Problem 2:** BFF mock was stateless. `GetPluginSources` always returned the same hardcoded
data regardless of mutations. Toggle switches appeared to reset on page refresh, added
sources didn't appear in the list, and deleted sources reappeared.

**Fix:** Made `ModelCatalogClientMock` stateful:
- Added `pluginSources map[string][]models.SourceInfo` to store per-plugin source state
- `pluginKeyFromBasePath()` derives plugin key ("mcp" or "model") from the API base path
- `initPluginSources()` lazy-initializes default data on first access
- `GetPluginSources()` reads from in-memory state
- `EnablePluginSource()` finds source by ID and updates `Enabled` + `Status.State` in place
- `ApplyPluginSourceConfig()` updates existing source or appends new one
- `DeletePluginSource()` removes source from the list
- All mutations persist across requests within the same server session

## Files Modified

### BFF Go Backend
| File | Change |
|------|--------|
| `bff/internal/models/catalog_management.go` | Added `SourceStatus` struct, `Properties` field, updated `SourceInfo` |
| `bff/internal/models/mcp_catalog.go` | Added `McpTool`, `McpToolParameter`, `McpResource`; extended `McpServer` with `SourceLabel` |
| `bff/internal/models/catalog_plugin.go` | Added `CatalogPluginManagement`, `Management` field |
| `bff/internal/mocks/model_catalog_client_mock.go` | Stateful mock with `pluginSources map[string][]models.SourceInfo`; plugin-specific sources (7 model, 2 MCP); tool data for 7 servers; `SourceLabel` on all MCP servers; `EnablePluginSource`/`ApplyPluginSourceConfig`/`DeletePluginSource` mutations persist in-memory |
| `bff/internal/mocks/static_data_mock.go` | Management capabilities in plugin mocks |

### Frontend TypeScript/React
| File | Change |
|------|--------|
| `frontend/src/app/mcpCatalogTypes.ts` | Added tool/resource types, `MCP_ALL_CATEGORIES`, `MCP_OTHER_SERVERS`, `MCP_OTHER_SERVERS_DISPLAY`, `sourceLabel` field |
| `frontend/src/app/context/mcpCatalog/McpCatalogContext.tsx` | Category state, dynamic filter values (incl. `sourceLabels`), clear filters, `sourceLabel`-based tab filtering |
| `frontend/src/app/pages/mcpCatalog/components/McpCatalogFilters.tsx` | Dynamic filters with search/show-more |
| `frontend/src/app/pages/mcpCatalog/screens/McpCatalogPage.tsx` | `ThemeAwareSearchInput`, source-label-based `ToggleGroup` tabs, `ToolbarFilter` chips, `Stack`/`StackItem` layout |
| `frontend/src/app/pages/mcpCatalog/screens/McpServerDetailPage.tsx` | Two-column layout redesign |
| `frontend/src/app/pages/mcpCatalog/components/McpToolCard.tsx` | NEW: Expandable tool card |
| `frontend/src/app/pages/mcpCatalog/components/McpReadme.tsx` | NEW: Markdown renderer |
| `frontend/src/app/pages/mcpCatalog/components/McpServerDetailsSidebar.tsx` | NEW: Metadata sidebar |
| `frontend/src/app/pages/catalogManagement/screens/PluginSourcesPage.tsx` | Full rewrite with management features; model plugin redirect to Model Catalog Settings pages |
| `frontend/src/app/pages/catalogManagement/screens/PluginSourceConfigPage.tsx` | NEW: Add/manage source form with Sidebar layout, FileUpload, preview panel |
| `frontend/src/app/pages/catalogManagement/CatalogManagementRoutes.tsx` | Added routes, fixed nesting |
| `frontend/src/app/routes/catalogManagement/catalogManagement.ts` | Added route helpers |

## Verification Results

### Round 1: Core Functionality (8 tests)

| Test | Page | Result |
|------|------|--------|
| Model Sources | `/catalog-management/plugin/model/sources` | PASS - 7 sources, toolbar, kebab menu |
| Add Source | `/catalog-management/plugin/model/sources/add` | PASS - Standalone form, breadcrumbs |
| Manage Source | `/catalog-management/plugin/model/sources/sample-source/manage` | PASS - Pre-filled form |
| MCP Sources | `/catalog-management/plugin/mcp/sources` | PASS - 2 sources |
| MCP Gallery | `/mcp-catalog` | PASS - 7 cards, tabs, filters |
| MCP Detail | `/mcp-catalog/kubernetes-mcp-server` | PASS - Tools, readme, sidebar |
| Model Catalog | `/model-catalog` | PASS - Backward compatible |
| Catalog Mgmt | `/catalog-management` | PASS - Both plugins listed |

### Round 2: Styling & YAML Loading (5 tests)

| Test | Page | Result |
|------|------|--------|
| MCP Add Source | `/catalog-management/plugin/mcp/sources/add` | PASS - Sidebar layout, FileUpload, preview panel, breadcrumbs |
| MCP Manage Source | `/catalog-management/plugin/mcp/sources/mcp-yaml-source/manage` | PASS - Pre-filled name, YAML content loaded (499 chars), Save button |
| Model Add Source | `/catalog-management/plugin/model/sources/add` | PASS - Redirects to `/model-catalog-settings/add-source` |
| Model Sources | `/catalog-management/plugin/model/sources` | PASS - 7 sources, Add button |
| MCP Sources | `/catalog-management/plugin/mcp/sources` | PASS - 2 sources, kebab with Manage/View/Delete |

### Round 3: Model Plugin Redirect & Source ID Alignment

| Test | Page | Result |
|------|------|--------|
| Model Add Source redirect | "Add a source" on model plugin | PASS - Navigates to `/model-catalog-settings/add-source` |
| Model Manage Source redirect | "Manage source" on model plugin | PASS - Navigates to `/model-catalog-settings/manage-source/:id` |
| Model Manage Source form loads | `/model-catalog-settings/manage-source/sample_source_models` | PASS - Form loads with pre-filled data (no loading spinner) |
| MCP Add Source unchanged | "Add a source" on MCP plugin | PASS - Uses generic `PluginSourceConfigPage` |

### Round 4: Stateful Mock (Toggle, Add, Delete Persistence)

| Test | Page | Result |
|------|------|--------|
| MCP toggle persistence | Toggle switch on MCP sources | PASS - Enabled/disabled state persists after page refresh |
| MCP add source persistence | Add new source via form | PASS - New source appears in sources table |
| MCP delete persistence | Delete source via kebab menu | PASS - Source removed from table |
| Model toggle persistence | Toggle switch on model sources | PASS - State persists across requests |

### Round 5: MCP Gallery Redesign (Source-Label Tabs & ThemeAwareSearchInput)

| Test | Page | Result |
|------|------|--------|
| Source-label tabs | `/mcp-catalog` | PASS - "All servers", "MCP YAML Source servers", "Community Servers servers" tabs |
| Old category tabs removed | `/mcp-catalog` | PASS - "Red Hat servers", "Database servers", etc. no longer present |
| ThemeAwareSearchInput | `/mcp-catalog` | PASS - Field label, arrow-right button, min-width 600px |
| Tab filtering (YAML) | Click "MCP YAML Source servers" | PASS - Filters to 5 server cards |
| Tab filtering (Community) | Click "Community Servers servers" | PASS - Filters to 2 server cards |
| Tab filtering (All) | Click "All servers" | PASS - Shows all 7 server cards |
| Live search | Type "kubernetes" in search | PASS - Filters to matching servers |
| Filter sidebar | Left sidebar | PASS - Deployment Mode, Category, License, Transport filters |
| MCP Detail page | `/mcp-catalog/kubernetes-mcp-server` | PASS - Two-column layout, tools, sidebar |
| Model Catalog compat | `/model-catalog` | PASS - Backward compatible, loads correctly |
| MCP Sources compat | `/catalog-management/plugin/mcp/sources` | PASS - Table with rows |

## Build Verification

- Go build: `go build ./cmd/...` passes clean
- Go vet: `go vet ./...` passes clean
- TypeScript: `npx tsc --noEmit` passes clean with zero errors
