# M2.4: Tests, Verification, and Dev Environment Fixes

**Date**: 2026-02-15
**Status**: Complete
**Phase**: Phase 2: Catalog Management Experience

## Summary

This milestone delivered unit tests for the RBAC middleware and management handlers, fixed TypeScript compilation errors for PatternFly compatibility, resolved httprouter route conflicts, and added a fake Kubernetes clientset fallback so the BFF runs on Windows without envtest binaries. The full UI stack was verified end-to-end using Playwright.

## Motivation

- Unit tests are required for all new framework utilities per repo conventions (addresses **10_testing_acceptance_and_release** requirements).
- The BFF dev server was non-functional on Windows due to envtest's etcd dependency.
- Route conflicts in httprouter prevented the BFF from starting.
- PatternFly v6 removed `variant="light"` from `PageSection`, breaking TypeScript compilation.

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/plugin/rbac_test.go` | 11 test cases for RBAC role extraction and middleware enforcement |
| `pkg/catalog/plugin/management_handlers_test.go` | 10 test cases for management HTTP handlers and RBAC integration |
| `clients/ui/bff/internal/integrations/kubernetes/k8mocks/fake_clientset.go` | `SetupFakeClientset()` for Windows dev support |

### Files Modified

| File | Change |
|------|--------|
| `clients/ui/frontend/src/app/pages/catalogManagement/screens/PluginDetailPage.tsx` | Removed `variant="light"` from two `PageSection` components (PatternFly v6 compatibility) |
| `clients/ui/bff/internal/api/app.go` | Changed `CatalogPluginSourceValidatePath` from `/sources/validate` to `/validate-source`; same for apply; added fake clientset fallback |
| `clients/ui/bff/internal/repositories/catalog_management.go` | Updated `mgmtValidatePath` and `mgmtApplyPath` constants |
| `clients/ui/frontend/src/app/api/catalogManagement/service.ts` | Updated validate/apply URL paths to match BFF route changes |
| `pkg/catalog/plugin/management_handlers.go` | Updated validate/apply routes to `/validate-source` and `/apply-source` |
| `pkg/catalog/plugin/management_handlers_test.go` | Updated test request URLs to match new paths |
| `clients/ui/bff/internal/integrations/kubernetes/k8mocks/base_testenv.go` | Replaced 3 `os.Exit(1)` calls with `return nil, nil, fmt.Errorf(...)` |
| `clients/ui/bff/internal/integrations/kubernetes/k8mocks/mock_factory.go` | Added `testEnv == nil` guard for token auth path |

## How It Works

### RBAC Tests (`rbac_test.go`)

Table-driven tests covering:
- `TestDefaultRoleExtractor`: header parsing for "operator", "viewer", "Operator" (case), empty, missing, unknown values
- `TestRequireRoleMiddleware`: viewer accessing viewer-only route (200), viewer accessing operator route (403), operator accessing operator route (200), custom extractor, nil extractor fallback

### Management Handler Tests (`management_handlers_test.go`)

Tests with mock plugin implementations (`mgmtTestPlugin`, `testMgmtPlugin`):
- `TestSourcesListHandler`: verifies JSON response format with count and sources array
- `TestValidateHandler`: valid config returns 200 with `valid: true`; invalid JSON body returns 400
- `TestRefreshAllHandler`: returns refresh result with entities loaded count
- `TestRefreshSourceHandler`: uses chi router for URL params, verifies source ID propagation
- `TestDiagnosticsHandler`: verifies diagnostics response structure
- `TestEnableHandler`: verifies enable/disable toggle response
- `TestDeleteSourceHandler`: verifies deletion response
- `TestManagementRouterRBAC`: integration test with full management router; verifies viewer can list sources and get diagnostics; viewer cannot apply source (403) or refresh (403); operator can apply source (200)

### Route Conflict Fix

httprouter (used by BFF) cannot mix wildcard parameters with static children at the same path level:
```
/sources/:source_id    -- wildcard
/sources/validate      -- static child (CONFLICT!)
```

Fixed by moving validate/apply to top-level action paths:
```
Before: /sources/validate, /sources/apply
After:  /validate-source, /apply-source
```

This change was applied consistently across all 4 layers: catalog server handlers, handler tests, BFF routes/repository, and frontend API service.

### Fake Clientset Fallback

When envtest's `SetupEnvTest()` fails (missing etcd binary), the BFF now falls back to `fake.NewSimpleClientset()` and populates it with the same mock data via `SetupFakeClientset()`:

```go
func SetupFakeClientset(clientset kubernetes.Interface, logger *slog.Logger) error {
    ctx := context.Background()
    logger.Info("Populating fake clientset with mock data")
    return setupMock(clientset, ctx)  // reuses existing mock data setup
}
```

This required changing `SetupEnvTest` from `os.Exit(1)` to error returns, enabling the caller to catch the failure and try the fallback path.

### Playwright Verification

End-to-end verification confirmed:
1. **Catalog Management gallery** renders at `/catalog-management` with both `model` and `mcp` plugin cards
2. **Plugin detail page** renders at `/catalog-management/plugin/model/sources` with breadcrumb, tabs, and source table
3. **Navigation** shows "Catalog Management" under Settings dropdown
4. **Backward compatibility** -- existing Model Catalog page at `/model-catalog` renders fully with all filters and model cards

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Separate mock plugin types in test file | Avoids name collision with `testPlugin` in `server_test.go` | Shared test helpers package |
| Reuse `setupMock()` for fake clientset | Same mock data as envtest path; no duplication | Separate mock data setup for fake clientset |
| `os.Exit` -> error return in `SetupEnvTest` | Enables graceful fallback; `os.Exit` is untestable | Wrapper binary that restarts on exit |

## Testing

Run all management tests:
```bash
# RBAC tests
go test ./pkg/catalog/plugin/... -run TestRequireRole -v
go test ./pkg/catalog/plugin/... -run TestDefaultRoleExtractor -v

# Handler tests
go test ./pkg/catalog/plugin/... -run "TestSources|TestValidate|TestRefresh|TestDiagnostics|TestEnable|TestDelete|TestManagement" -v

# All plugin package tests
go test ./pkg/catalog/plugin/... -v
```

## Verification

```bash
# Run unit tests
go test ./pkg/catalog/plugin/... -v -count=1

# Build BFF (verifies compilation)
cd clients/ui/bff && go build ./cmd/

# Start full dev stack
cd clients/ui/bff && go run ./cmd/ --port=4000 --mock-k8s-client=true \
  --mock-mr-client=true --mock-mr-catalog-client=true --dev-mode=true \
  --deployment-mode=standalone &

cd clients/ui/frontend && DEPLOYMENT_MODE=standalone STYLE_THEME=mui-theme npm run start:dev &

# Verify in browser
open http://localhost:9000/catalog-management
```

## Dependencies & Impact

- **Depends on**: M2.1 (interfaces), M2.3 (BFF/UI code to test)
- **Enables**: M2.5 (CI integration, release readiness)
- **Side effect**: `SetupEnvTest` behavior change (returns error instead of `os.Exit`) improves testability for all existing BFF tests

## Open Items

- Integration tests against running catalog server (requires Docker Compose setup)
- Cypress/Playwright automated test suite for frontend flows
- BFF handler unit tests (currently only compile-verified; full test suite blocked by envtest on Windows)
- Coverage reporting for new management code
