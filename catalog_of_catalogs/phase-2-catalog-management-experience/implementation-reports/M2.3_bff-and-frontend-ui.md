# M2.3: BFF Proxy Handlers and Frontend UI

**Date**: 2026-02-15
**Status**: Complete
**Phase**: Phase 2: Catalog Management Experience

## Summary

This milestone delivered the full frontend stack for catalog management: BFF proxy handlers that forward management API calls to the catalog server, and a React/PatternFly UI with plugin gallery, source management tables, and diagnostics views. The UI is driven entirely by plugin discovery -- no hardcoded plugin types.

## Motivation

- Operators need a visual interface for managing catalog plugins, sources, and diagnosing issues (addresses **B1-B4**, **C1-C3**).
- The UI must be plugin-agnostic, rendering management screens for any plugin type at runtime (addresses **A2**, **E1**).
- The BFF layer must proxy management calls to the catalog server, resolving plugin base paths dynamically (addresses **A1**).
- Source management actions must respect RBAC (addresses **D1**, **D2**).

## What Changed

### Files Created

**BFF Backend (Go)**

| File | Purpose |
|------|---------|
| `clients/ui/bff/internal/api/catalog_management_handler.go` | 8 HTTP handlers: GetPluginSources, ValidatePluginSourceConfig, ApplyPluginSourceConfig, EnablePluginSource, DeletePluginSource, RefreshPlugin, RefreshPluginSource, GetPluginDiagnostics |
| `clients/ui/bff/internal/repositories/catalog_management.go` | `CatalogManagementInterface` with 9 methods; `ResolvePluginBasePath` fetches `/api/plugins` and finds basePath by name |
| `clients/ui/bff/internal/models/catalog_management.go` | BFF model types: `SourceInfo`, `SourceInfoList`, `SourceConfigPayload`, `ValidationResult`, `RefreshResult`, `PluginDiagnostics` |
| `clients/ui/bff/internal/integrations/kubernetes/k8mocks/fake_clientset.go` | `SetupFakeClientset()` -- populates `fake.NewSimpleClientset` with mock data for Windows dev (no envtest needed) |

**Frontend (TypeScript/React)**

| File | Purpose |
|------|---------|
| `clients/ui/frontend/src/app/catalogManagementTypes.ts` | TypeScript types mirroring Go management types |
| `clients/ui/frontend/src/app/api/catalogManagement/service.ts` | API service functions using `mod-arch-core` utilities (`restGET`, `restCREATE`, `restDELETE`) |
| `clients/ui/frontend/src/app/context/catalogManagement/CatalogManagementContext.tsx` | React context: fetches plugins on mount, exposes `apiState`, `plugins`, `selectedPlugin` |
| `clients/ui/frontend/src/app/routes/catalogManagement/catalogManagement.ts` | Route helpers: `catalogManagementUrl()`, `catalogPluginUrl()`, etc. |
| `clients/ui/frontend/src/app/pages/catalogManagement/CatalogManagementRoutes.tsx` | Route definitions with `CatalogManagementContextProvider` wrapping nested routes |
| `clients/ui/frontend/src/app/pages/catalogManagement/screens/CatalogManagementPage.tsx` | Plugin gallery using PatternFly `Card`, `Gallery`, `Label`, `LabelGroup` |
| `clients/ui/frontend/src/app/pages/catalogManagement/screens/PluginDetailPage.tsx` | Plugin detail with PatternFly `Tabs`, `Breadcrumb`; Sources and Diagnostics tabs |
| `clients/ui/frontend/src/app/pages/catalogManagement/screens/PluginSourcesPage.tsx` | Source table with enable/disable, delete, refresh-all actions |
| `clients/ui/frontend/src/app/pages/catalogManagement/screens/PluginDiagnosticsPage.tsx` | Diagnostics view with `DescriptionList` and `Table` |

### Files Modified

| File | Change |
|------|--------|
| `clients/ui/bff/internal/api/app.go` | Added 10 route constants (`CatalogPluginManagementPrefix`, etc.); registered 8 catalog management routes in `Routes()`; added `fake.NewSimpleClientset` fallback when envtest fails; added `"k8s.io/client-go/kubernetes/fake"` import |
| `clients/ui/bff/internal/repositories/model_catalog_client.go` | Embedded `CatalogManagementInterface` in `ModelCatalogClientInterface`; added `CatalogManagement` field to `ModelCatalogClient` struct |
| `clients/ui/bff/internal/integrations/httpclient/http.go` | Added `DELETE` method to `HTTPClientInterface` and `HTTPClient` |
| `clients/ui/bff/internal/mocks/model_catalog_client_mock.go` | Added mock implementations for all management interface methods |
| `clients/ui/bff/internal/mocks/http_mock.go` | Added `DELETE` mock |
| `clients/ui/bff/internal/integrations/kubernetes/k8mocks/base_testenv.go` | Changed `os.Exit(1)` calls to `return nil, nil, fmt.Errorf(...)` for graceful fallback |
| `clients/ui/bff/internal/integrations/kubernetes/k8mocks/mock_factory.go` | Added nil guard for `testEnv` in token auth path |
| `clients/ui/frontend/src/app/AppRoutes.tsx` | Added `CatalogManagementRoutes` import and route; added "Catalog Management" to Settings nav |

## How It Works

### BFF Proxy Pattern

The BFF handlers follow the existing repo pattern:

1. Extract HTTP client from request context (via `AttachModelCatalogRESTClient` middleware)
2. Extract `plugin_name` from URL parameter
3. Call `ResolvePluginBasePath(client, pluginName)` to discover the plugin's API base path
4. Call the appropriate repository method which constructs the upstream URL and forwards the request
5. Write the response as a JSON envelope

```
Frontend  -->  BFF (localhost:4000)  -->  Catalog Server (localhost:8081)
  React        httprouter handlers       chi management routes
               /api/v1/catalog/:name     /api/{plugin_base}/sources
```

### BFF Route Structure

| Method | BFF Path | Upstream Path |
|--------|----------|---------------|
| GET | `/api/v1/catalog/:plugin_name/sources` | `{basePath}/sources` |
| POST | `/api/v1/catalog/:plugin_name/validate-source` | `{basePath}/validate-source` |
| POST | `/api/v1/catalog/:plugin_name/apply-source` | `{basePath}/apply-source` |
| POST | `/api/v1/catalog/:plugin_name/sources/:source_id/enable` | `{basePath}/sources/{id}/enable` |
| DELETE | `/api/v1/catalog/:plugin_name/sources/:source_id` | `{basePath}/sources/{id}` |
| POST | `/api/v1/catalog/:plugin_name/refresh` | `{basePath}/refresh` |
| POST | `/api/v1/catalog/:plugin_name/refresh/:source_id` | `{basePath}/refresh/{id}` |
| GET | `/api/v1/catalog/:plugin_name/diagnostics` | `{basePath}/diagnostics` |

### Frontend Architecture

```
AppRoutes.tsx
  |-- /catalog-management/*  -->  CatalogManagementRoutes.tsx
       |                           (wrapped in CatalogManagementContextProvider)
       |-- /                  -->  CatalogManagementPage.tsx  (plugin gallery)
       |-- /plugin/:name      -->  PluginDetailPage.tsx       (tabs container)
            |-- /sources      -->  PluginSourcesPage.tsx      (source table)
            |-- /diagnostics  -->  PluginDiagnosticsPage.tsx  (diagnostics)
```

### Plugin Gallery (CatalogManagementPage)

Renders a PatternFly `Gallery` of `Card` components, one per plugin. Each card shows:
- Plugin name with health indicator (green check / red exclamation)
- Description and version
- Entity types as `Label` components in a `LabelGroup`
- Click navigates to plugin detail page

### Source Management Table (PluginSourcesPage)

PatternFly `Table` (react-table) displaying:
- Name, ID, Type, Status (color-coded `Label`), Entity count
- Actions column (when plugin supports `sourceManager`): Enable/Disable toggle, Delete button
- Toolbar with "Refresh all sources" button (when plugin supports `refresh`)

### Diagnostics View (PluginDiagnosticsPage)

- `DescriptionList` showing plugin name and last refresh time
- Error alerts for active diagnostic errors
- `Table` showing per-source status: name, ID, state, entity count, last refresh, error

### Windows Dev Support (fake clientset)

The BFF requires envtest (etcd + kube-apiserver binaries) for its mock K8s client. These are unavailable on Windows. A fallback was added:

```go
// In app.go NewApp():
if err != nil {
    // Fallback to fake.NewSimpleClientset when envtest binaries unavailable
    logger.Warn("envtest unavailable, falling back to fake clientset")
    clientset = fake.NewSimpleClientset()
    k8mocks.SetupFakeClientset(clientset, logger) // populates same mock data
}
```

This reuses the existing `setupMock()` function to populate namespaces, services, RBAC, and ConfigMaps identically to the envtest path.

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| `validate-source` / `apply-source` paths (not nested under `/sources/`) | httprouter cannot mix wildcard `:source_id` with static children `validate`/`apply` at same level | Nested paths (caused httprouter panic); different router library |
| Plugin base path resolved via `/api/plugins` in BFF repository | Same discovery mechanism as CLI; no hardcoded paths; works for any plugin type | Hardcoded path mapping in BFF config |
| `CatalogManagementContext` as separate React context | Isolates management state from existing catalog browsing context | Extending existing `ModelCatalogContext` |
| `fake.NewSimpleClientset` fallback | Enables Windows dev without installing etcd; same mock data as envtest path | Requiring WSL/Linux for development |
| `os.Exit` replaced with error returns in `SetupEnvTest` | Allows graceful fallback logic in caller; `os.Exit` prevented any recovery | Wrapper function that catches `os.Exit` (not possible in Go) |

## Testing

- BFF compilation verified (`go build ./cmd/` in `clients/ui/bff/`)
- Frontend TypeScript compilation verified (`No typescript errors found` from webpack)
- Visual verification with Playwright:
  - Catalog Management gallery page renders both plugins with health indicators
  - Plugin detail page shows breadcrumb, tabs, and source table with live data
  - Existing Model Catalog page continues to work (backward compatibility)

## Verification

```bash
# Start BFF (with fake clientset fallback on Windows)
cd clients/ui/bff
go run ./cmd/ --port=4000 --mock-k8s-client=true --mock-mr-client=true \
  --mock-mr-catalog-client=true --dev-mode=true --deployment-mode=standalone

# Start frontend
cd clients/ui/frontend
DEPLOYMENT_MODE=standalone STYLE_THEME=mui-theme npm run start:dev

# Navigate to:
# http://localhost:9000/catalog-management          -- Plugin gallery
# http://localhost:9000/catalog-management/plugin/model/sources     -- Model sources
# http://localhost:9000/catalog-management/plugin/mcp/sources       -- MCP sources
# http://localhost:9000/model-catalog               -- Existing catalog (backward compat)
```

## Dependencies & Impact

- **Depends on**: M2.1 (management API endpoints), Phase 1 M4 (BFF plugin discovery)
- **Enables**: M2.4 (extensibility patterns, UI hints rendering), M2.5 (end-to-end testing)
- **Backward compatible**: Existing Model Catalog, Model Registry, and Settings pages are unaffected
- **New nav entry**: "Catalog Management" added under Settings (only in Standalone/Federated mode)

## Open Items

- Diagnostics tab is wired but only appears when `plugin.management.diagnostics` is set in the discovery response (requires full catalog server)
- Source create/edit form UI (currently only table view with enable/disable/delete)
- Refresh progress indicator (currently shows success/error after completion)
- Pagination on source list (not needed until source counts exceed ~50)
- Error boundary for individual API failures (currently shows generic alert)
