# M2.2: CLI MVP

**Date**: 2026-02-15
**Status**: Complete
**Phase**: Phase 2: Catalog Management Experience

## Summary

This milestone delivered a standalone CLI binary (`cmd/catalog/`) that provides full management operations against the catalog server: plugin discovery, source CRUD, refresh triggers, and diagnostics. It supports table, JSON, and YAML output formats for both interactive and scripted use.

## Motivation

- Operators need a CLI tool for scripted management, CI/CD pipelines, and environments where the UI is not available (addresses **B1-B4**, **C3**).
- The CLI must support JSON output for programmatic consumption and table output for human readability (addresses Milestone 2.2 outcomes).
- CLI integration should be plugin-agnostic, driven by the same `/api/plugins` discovery endpoint as the UI.

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| `cmd/catalog/main.go` | Root command with `--server` and `--output` flags, HTTP client wrapper |
| `cmd/catalog/plugins.go` | `catalog plugins list` and `catalog plugins get <name>` commands |
| `cmd/catalog/sources.go` | `catalog sources list/validate/apply/enable/disable/delete` commands |
| `cmd/catalog/refresh.go` | `catalog refresh trigger [--source]` command |
| `cmd/catalog/status.go` | `catalog status` command with server overview and per-plugin diagnostics |
| `cmd/catalog/output.go` | Output formatting: `outputFormat` type, table/JSON/YAML renderers using `text/tabwriter` |

### Files Modified

_No existing files were modified for this milestone._

## How It Works

### Command Structure

```
catalog
  plugins
    list          List all installed plugins
    get <name>    Get details for a specific plugin
  sources
    list          List sources for a plugin (--plugin required)
    validate      Validate a source config from file (--plugin, --file required)
    apply         Apply a source config from file (--plugin, --file required)
    enable        Enable a source (--plugin, --source required)
    disable       Disable a source (--plugin, --source required)
    delete        Delete a source (--plugin, --source required)
  refresh
    trigger       Trigger refresh (--plugin required, --source optional)
  status          Show server status with per-plugin diagnostics
```

### Global Flags

| Flag | Default | Description |
|------|---------|-------------|
| `--server` | `http://localhost:8081` | Catalog server URL |
| `--output` | `table` | Output format: `table`, `json`, `yaml` |

### Output Formatting

The `output.go` module provides three renderers:

- **Table**: `text/tabwriter` with aligned columns for terminal display
- **JSON**: `json.MarshalIndent` for structured output
- **YAML**: `encoding/json` round-trip to `yaml.Marshal` for config-file-compatible output

### HTTP Client

The `catalogClient` struct wraps `net/http.Client` and provides typed methods:
- `get(path)` / `post(path, body)` / `delete(path)` - return `*http.Response`
- Plugin base path resolution via `GET /api/plugins` endpoint

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Cobra framework | Matches existing `cmd/proxy` patterns in the repo | Raw `flag` package |
| Standalone binary (not subcommand of proxy) | CLI is a client tool, separate from the server process | Subcommand of proxy binary |
| Plugin base path resolved from `/api/plugins` | Same discovery mechanism as UI; no hardcoded paths | Hardcoded paths per plugin type |
| File-based input for validate/apply | JSON/YAML config files are standard for ops workflows | Inline flags for each field |

## Testing

- CLI commands can be tested against a running catalog server
- JSON output mode enables programmatic verification in scripts

Run:
```bash
# Build the CLI
go build -o bin/catalog ./cmd/catalog

# Smoke test
./bin/catalog --help
./bin/catalog plugins list --output json
```

## Verification

```bash
# Build
go build -o bin/catalog ./cmd/catalog

# List plugins
./bin/catalog plugins list
./bin/catalog plugins list --output json

# Get plugin details
./bin/catalog plugins get model

# List sources for a plugin
./bin/catalog sources list --plugin model

# Server status with diagnostics
./bin/catalog status

# Trigger refresh
./bin/catalog refresh trigger --plugin model

# Validate a source config
./bin/catalog sources validate --plugin model --file source-config.json

# Apply a source config
./bin/catalog sources apply --plugin model --file source-config.json

# Enable/disable a source
./bin/catalog sources enable --plugin model --source src1
./bin/catalog sources disable --plugin model --source src1

# Delete a source
./bin/catalog sources delete --plugin model --source src1
```

## Dependencies & Impact

- **Depends on**: M2.1 (management plane API endpoints)
- **Enables**: M2.5 (end-to-end testing, operator documentation)
- **No impact on existing code**: standalone binary with no modifications to existing packages

## Open Items

- Interactive confirmation prompts for destructive operations (delete, disable) are not yet implemented
- `--namespace` flag for multi-tenant deployments
- Shell completion support (Cobra supports this natively but not yet wired)
- Integration tests against a local dev deployment
