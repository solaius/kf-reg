# M4.5: Testing and Verification

**Date**: 2026-02-16
**Status**: Complete
**Phase**: Phase 4 - Catalog Management Productionization

## Summary

Comprehensive test coverage was added across all Phase 4 features: 89 top-level tests and 170+ assertions in `pkg/catalog/plugin/`, covering the multi-layer validator, ConfigStore backends (File and K8s), management handler endpoints, and health probes. E2E smoke tests exercise the full HTTP stack against a running catalog-server. BFF handler wiring and frontend components were verified via compilation checks.

## Motivation

- Phase 4 introduced significant new functionality (validation engine, revision history, rollback, enhanced health endpoints, K8s store) that required thorough test coverage.
- The management handlers gained complex interactions (pre-apply validation, refresh-after-apply, rollback with plugin re-init) that needed integration-level testing.
- E2E tests ensure the full stack (DB + catalog-server + HTTP) works correctly for the new Phase 4 endpoints.

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/plugin/validator_test.go` | Table-driven tests for each validation layer and combined validator |
| `pkg/catalog/plugin/k8s_config_store_test.go` | Unit tests for K8s ConfigMap store with fake clientset |
| `tests/e2e/catalog_phase4_smoke_test.go` | E2E smoke tests for Phase 4 endpoints (health, validate, revisions, rollback, refresh) |

### Files Modified

| File | Change |
|------|--------|
| `pkg/catalog/plugin/file_config_store_test.go` | Added 6 new tests for revisions, rollback, path traversal, oversized files, history pruning |
| `pkg/catalog/plugin/management_handlers_test.go` | Added 12 new tests for validate, revisions, rollback, apply-rejects-invalid, refresh-after-apply |
| `pkg/catalog/plugin/server_test.go` | Added tests for /livez alias, enhanced /readyz component structure |

## Test Coverage by Feature

### Validation Engine (`validator_test.go`)

| Test | What It Verifies |
|------|-----------------|
| `TestYAMLParseLayer_Valid` | Valid YAML passes parse layer |
| `TestYAMLParseLayer_Invalid` | Broken YAML is detected with error message |
| `TestYAMLParseLayer_NoContent` | Missing content field is gracefully skipped |
| `TestStrictFieldsLayer_Valid` | Known fields pass strict check |
| `TestStrictFieldsLayer_Unknown` | Unknown YAML fields are detected |
| `TestSemanticLayer_AllRequired` | Missing id/name/type produce errors |
| `TestSemanticLayer_InvalidID` | Non-matching ID pattern is rejected |
| `TestSemanticLayer_LongName` | Name > 256 chars is rejected |
| `TestProviderLayer_Valid` | Provider validation delegation works |
| `TestProviderLayer_Invalid` | Provider errors are surfaced |
| `TestMultiLayerValidator_CriticalStops` | Critical layer failure stops pipeline |
| `TestNewDefaultValidator_*` | Default validator creation with/without SourceManager |

### ConfigStore (`file_config_store_test.go`, `k8s_config_store_test.go`)

FileConfigStore:
- `TestRevisionCreatedOnSave` - Snapshot appears in .history/ after Save
- `TestListRevisions` - Returns entries sorted newest first
- `TestRollbackRestoresPrevious` - Full rollback restores previous config
- `TestHistoryPruning` - Only 20 most recent snapshots kept
- `TestPathTraversal` - Paths with `..` are rejected
- `TestOversizedFile` - Files > 1 MiB are rejected

K8sSourceConfigStore (14 tests):
- Load/Save with ConfigMap data key
- Version conflict detection via content hash
- ListRevisions from annotations
- Rollback with snapshot restoration
- Empty/missing ConfigMap handling

### Management Handlers (`management_handlers_test.go`)

| Test | What It Verifies |
|------|-----------------|
| `TestDetailedValidateHandler` | Layered validation response with per-layer breakdown |
| `TestRevisionsHandler` | Returns revision list from ConfigStore |
| `TestRevisionsHandler_NoConfigStore` | Returns empty array when no store configured |
| `TestRollbackHandler` | Restores previous revision, returns rolled_back status |
| `TestRollbackHandler_NotFound` | Returns 404 for unknown version |
| `TestRollbackHandler_MissingVersion` | Returns 400 for empty version |
| `TestApplyHandler_RejectsInvalid` | Returns 422 with validation errors for bad input |
| `TestApplyHandler_WithRefreshAfterApply` | Triggers refresh and includes result in response |
| `TestApplyHandler_WithoutRefreshAfterApply` | No refresh when flag is absent |

### Health Endpoints (`server_test.go`)

- `TestServerHealthEndpoint` - /healthz returns "alive" with uptime
- `TestServerHealthzLivezAlias` - /healthz and /livez return identical responses
- `TestServerReadyEndpoint` - /readyz returns 200 with component breakdown
- `TestServerReadyEndpointWithFailedPlugin` - /readyz returns 503 with "degraded" plugins

### E2E Smoke Tests (`catalog_phase4_smoke_test.go`)

| Test | What It Verifies |
|------|-----------------|
| `TestPhase4Livez` | GET /livez returns 200 with alive status and uptime |
| `TestPhase4Readyz` | GET /readyz returns 200 with database/initial_load/plugins components |
| `TestPhase4HealthzAlias` | GET /healthz returns same as /livez |
| `TestPhase4ValidateEndpointValidYAML` | Detailed validate accepts valid YAML |
| `TestPhase4ValidateEndpointInvalidYAML` | Detailed validate catches broken YAML |
| `TestPhase4ValidateEndpointUnknownFields` | Strict fields layer detects unknown fields |
| `TestPhase4ApplyRejectsInvalid` | Apply returns 422 for missing required fields |
| `TestPhase4ListRevisions` | Revisions endpoint returns array with count |
| `TestPhase4ListRevisionsAfterApply` | Two applies produce at least 2 revisions |
| `TestPhase4Rollback` | Full rollback flow: apply v1, apply v2, rollback to v1, verify |
| `TestPhase4RollbackNotFound` | Rollback to nonexistent version returns 404 |
| `TestPhase4ApplyWithRefreshAfterApply` | Apply with refresh returns entity counts |
| `TestPhase4ApplyWithoutRefreshAfterApply` | Apply without refresh omits refreshResult |

## How To Run

```bash
# All plugin package tests (89 tests)
go test ./pkg/catalog/plugin/... -v -count=1

# Validation tests only
go test ./pkg/catalog/plugin/... -v -run "TestYAML|TestStrict|TestSemantic|TestProvider|TestMultiLayer|TestDefault" -count=1

# ConfigStore tests only
go test ./pkg/catalog/plugin/... -v -run "TestFileConfigStore|TestK8s" -count=1

# Management handler tests only
go test ./pkg/catalog/plugin/... -v -run "TestDetailed|TestRevision|TestRollback|TestApply" -count=1

# Health endpoint tests only
go test ./pkg/catalog/plugin/... -v -run "TestServerHealth|TestServerReady" -count=1

# E2E smoke tests (requires running catalog-server)
CATALOG_SERVER_URL=http://localhost:8080 go test ./tests/e2e/ -v -run TestPhase4 -count=1

# Verify all Go code compiles
go vet ./pkg/catalog/plugin/... ./cmd/catalog-server/... ./cmd/healthcheck/... ./tests/e2e/...
```

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Table-driven tests for validator layers | Each layer has clear input/expected-output pairs; easy to add new cases | Individual test functions per case |
| Fake K8s clientset for K8s store tests | No cluster dependency; fast; deterministic | Real cluster via kind/minikube (slow, flaky) |
| E2E tests skip when server unavailable | Tests can run in any environment; CI with Docker Compose enables them | Require server always running (breaks local dev) |
| Mock SourceManager in handler tests | Isolates handler logic from plugin implementation | Use real MCP plugin (too many dependencies) |

## Verification

```bash
# Run all tests
go test ./pkg/catalog/plugin/... -v -count=1
# Expected: ok, 89 tests, ~0.3s

# Verify E2E test compilation
go vet ./tests/e2e/...

# Verify BFF compilation
cd clients/ui/bff && go vet ./...
```

## Dependencies & Impact

- **Depends on**: All M4.1-M4.4 implementations
- **Enables**: Confidence in Phase 4 functionality; CI gate for regressions
- Tests use existing Phase 3 test infrastructure (`testMgmtPlugin`, `doGet`/`doPost`/`doDelete` helpers)

## Open Items

- BFF handler tests depend on a running catalog-server (integration-level); unit tests with mocked HTTP client would improve isolation
- Playwright UI tests are defined but require a running frontend + BFF + catalog-server stack for execution
- Test coverage reporting (`go test -cover`) is available but not enforced in CI yet
