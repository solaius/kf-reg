# M4.2: Validation, Safety, and Rollback

**Date**: 2026-02-16
**Status**: Complete
**Phase**: Phase 4 - Catalog Management Productionization

## Summary

Implemented a multi-layer YAML validation engine that catches errors at four levels (parse, strict fields, semantic, provider) before allowing source configuration changes. Added three new management endpoints for detailed validation, revision history listing, and config rollback. The apply handler now pre-validates all inputs, rejecting invalid configs with 422 before mutating state.

## Motivation

- In Phase 3, invalid YAML could be saved and break the catalog at refresh time -- there was no pre-save validation.
- Operators had no way to view the history of config changes or revert to a known-good state.
- The lack of layered error reporting made it hard to diagnose whether problems were syntax errors, unknown fields, or semantic issues.

## What Changed

### Files Created

| File | Purpose |
|------|---------|
| `pkg/catalog/plugin/validator.go` | Multi-layer validation engine with 4 built-in layers |
| `pkg/catalog/plugin/validator_test.go` | Table-driven tests for each validation layer |

### Files Modified

| File | Change |
|------|--------|
| `pkg/catalog/plugin/management_handlers.go` | Added `detailedValidateHandler`, `revisionsHandler`, `rollbackHandler`; modified `applyHandler` for pre-apply validation |
| `pkg/catalog/plugin/management_handlers_test.go` | Added tests for validate, revisions, rollback, and apply-rejects-invalid |

## How It Works

### Multi-Layer Validation Engine

The `MultiLayerValidator` runs a pipeline of `ValidationLayer` checks. Each layer can be marked `Critical`, meaning failure stops further validation (to avoid cascading nonsensical errors).

```go
type MultiLayerValidator struct {
    layers []ValidationLayer
}

type ValidationLayer struct {
    Name     string
    Critical bool
    Check    func(ctx context.Context, input SourceConfigInput) []ValidationError
}

type DetailedValidationResult struct {
    Valid        bool                    `json:"valid"`
    Errors       []ValidationError       `json:"errors,omitempty"`
    Warnings     []ValidationError       `json:"warnings,omitempty"`
    LayerResults []LayerValidationResult `json:"layerResults,omitempty"`
}
```

Built-in layers (executed in order):

1. **yaml_parse** (Critical): Runs `yaml.Unmarshal` on `properties.content`. If YAML is syntactically broken, stops here.
2. **strict_fields**: Uses `yaml.NewDecoder` with `KnownFields(true)` to detect unknown fields in the YAML content.
3. **semantic**: Validates required fields (id, name, type), ID format (lowercase alphanumeric + hyphens/underscores), and name length (max 256 chars).
4. **provider**: Delegates to the plugin's `ValidateSource()` method for provider-specific checks.

### New Endpoints

Three new routes are registered in `managementRouter()`:

```go
r.Post("/sources/{sourceId}:validate", detailedValidateHandler(sm))
r.Get("/sources/{sourceId}/revisions", revisionsHandler(srv))
r.Post("/sources/{sourceId}:rollback", rollbackHandler(srv, configKey, p))
```

**Detailed Validate** (`POST /sources/{sourceId}:validate`): Runs the full multi-layer validator and returns a `DetailedValidationResult` with per-layer breakdown. Always returns 200 (validation errors are in the response body).

**Revisions** (`GET /sources/{sourceId}/revisions`): Returns the revision history from `ConfigStore.ListRevisions()`.

**Rollback** (`POST /sources/{sourceId}:rollback`): Accepts `{"version": "hash"}`, calls `ConfigStore.Rollback()`, and re-initializes the affected plugin with the restored configuration.

### Pre-Apply Validation

The `applyHandler` was modified to run `NewDefaultValidator(sm).Validate()` before applying. Invalid inputs are rejected with HTTP 422:

```go
validator := NewDefaultValidator(sm)
valResult := validator.Validate(r.Context(), input)
if !valResult.Valid {
    w.WriteHeader(http.StatusUnprocessableEntity)
    json.NewEncoder(w).Encode(valResult)
    return
}
```

## Key Design Decisions

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| Critical flag on yaml_parse layer | Avoids cascading errors from strict_fields trying to decode broken YAML | Run all layers always, deduplicate errors |
| Validate endpoint returns 200 with errors in body | Consistent with validation-as-query semantics; 422 reserved for apply rejection | Return 422 from validate too |
| Rollback re-inits plugin | Ensures runtime state matches restored config | Require manual plugin restart |
| ID regex: `^[a-z0-9][a-z0-9_-]*$` | Prevents whitespace, special chars in source IDs that could break URL routing | Allow uppercase, require manual escaping |

## Testing

Unit tests in `validator_test.go`:
- `TestYAMLParseLayer_Valid` / `_Invalid` / `_NoContent`
- `TestStrictFieldsLayer_Valid` / `_Unknown`
- `TestSemanticLayer_AllRequired` / `_InvalidID` / `_LongName`
- `TestProviderLayer_Valid` / `_Invalid` / `_Error`
- `TestMultiLayerValidator_CriticalStops`
- `TestNewDefaultValidator_WithAndWithoutSM`

Handler tests in `management_handlers_test.go`:
- `TestDetailedValidateHandler` - Tests layered validation response
- `TestRevisionsHandler` / `TestRevisionsHandler_NoConfigStore`
- `TestRollbackHandler` / `TestRollbackHandler_NotFound`
- `TestApplyHandler_RejectsInvalid` - Verifies 422 on bad input

```bash
go test ./pkg/catalog/plugin/... -v -run "TestValidator|TestDetailed|TestRevision|TestRollback|TestApply" -count=1
```

## Verification

```bash
# Unit tests
go test ./pkg/catalog/plugin/... -v -count=1

# With Docker stack running:
# Validate with invalid YAML
curl -s -X POST http://localhost:8080/api/mcp_catalog/v1alpha1/sources/mcp-default:validate \
  -H 'Content-Type: application/json' \
  -d '{"id":"test","name":"test","type":"yaml","properties":{"content":"broken: yaml: ["}}' | jq

# Apply with missing required fields (should return 422)
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/api/mcp_catalog/v1alpha1/apply-source \
  -H 'Content-Type: application/json' \
  -d '{"properties":{}}'

# List revisions
curl -s http://localhost:8080/api/mcp_catalog/v1alpha1/sources/mcp-default/revisions | jq
```

## Dependencies & Impact

- **Enables**: M4.3 (refresh feedback relies on the enhanced apply handler), M4.5 (E2E tests exercise these endpoints)
- **Depends on**: M4.1 (ConfigStore.ListRevisions/Rollback)
- **Backward compatible**: Existing apply calls that pass validation continue to work unchanged

## Open Items

- The `strict_fields` layer validates against `SourceConfig` struct; custom plugin-specific schemas could benefit from plugin-provided strict structs
- Warnings are supported in `DetailedValidationResult` but no layers currently emit them
