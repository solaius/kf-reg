# Generated by catalog-gen - you can modify this file

PACKAGE := github.com/kubeflow/model-registry/catalog/plugins/mcp
CATALOG_NAME := mcp
PROJECT_ROOT := $(shell pwd)
REPO_ROOT := $(shell git rev-parse --show-toplevel)

# Use local binary from repo bin/ if available, fall back to Docker
OPENAPI_GENERATOR ?= $(if $(wildcard $(REPO_ROOT)/bin/openapi-generator-cli),$(REPO_ROOT)/bin/openapi-generator-cli,docker run --rm -v $(PROJECT_ROOT):/local -w /local openapitools/openapi-generator-cli:v7.13.0)
CATALOG_GEN ?= $(if $(wildcard $(REPO_ROOT)/bin/catalog-gen),$(REPO_ROOT)/bin/catalog-gen,catalog-gen)

.PHONY: all build test gen/catalog gen/openapi gen/openapi-server gen/openapi-client clean

all: gen/openapi-server build

# Regenerate code from catalog.yaml
gen/catalog:
	$(CATALOG_GEN) generate

build:
	go build ./...

test:
	go test ./...

# Merge OpenAPI spec with generated components
api/openapi/openapi.yaml: api/openapi/src/openapi.yaml api/openapi/src/generated/components.yaml
	@echo "Merging OpenAPI specs..."
	@mkdir -p api/openapi
	@cat api/openapi/src/openapi.yaml > api/openapi/openapi.yaml
	@echo "" >> api/openapi/openapi.yaml
	@cat api/openapi/src/generated/components.yaml >> api/openapi/openapi.yaml
	@echo "Merged to api/openapi/openapi.yaml"

gen/openapi: api/openapi/openapi.yaml

# Generate OpenAPI server code (controllers, models, routers)
# The generated controller calls your service implementation in internal/server/openapi/api_*_service_impl.go
gen/openapi-server: api/openapi/openapi.yaml
	@echo "Generating OpenAPI server code..."
	@mkdir -p internal/server/openapi
	$(OPENAPI_GENERATOR) generate \
		-i api/openapi/openapi.yaml \
		-g go-server \
		-o internal/server/openapi \
		--package-name openapi \
		--ignore-file-override .openapi-generator-ignore \
		--additional-properties=outputAsLibrary=true,router=chi,sourceFolder=,onlyInterfaces=true,isGoSubmodule=true,enumClassPrefix=true
	@echo "Running goimports..."
	@command -v goimports >/dev/null 2>&1 && goimports -w internal/server/openapi || echo "goimports not found, skipping"
	@echo "Done"

# Generate OpenAPI client code (optional - for SDK generation)
gen/openapi-client: api/openapi/openapi.yaml
	@echo "Generating OpenAPI client code..."
	@mkdir -p pkg/openapi
	$(OPENAPI_GENERATOR) generate \
		-i api/openapi/openapi.yaml \
		-g go \
		-o pkg/openapi \
		--package-name openapi \
		--ignore-file-override .openapi-generator-ignore \
		--additional-properties=isGoSubmodule=true,enumClassPrefix=true
	@command -v goimports >/dev/null 2>&1 && goimports -w pkg/openapi || echo "goimports not found, skipping"
	@echo "Done"

clean:
	rm -rf internal/server/openapi/.openapi-generator
	rm -rf pkg/openapi/.openapi-generator
	rm -f api/openapi/openapi.yaml
