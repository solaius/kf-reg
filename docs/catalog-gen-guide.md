# catalog-gen Usage Guide

`catalog-gen` is a scaffolding and code generation tool for creating catalog plugins in the unified catalog server. It generates boilerplate code from a declarative `catalog.yaml` configuration, following patterns similar to `kubebuilder` for Kubernetes controllers.

## Installation

```bash
go build -o catalog-gen ./cmd/catalog-gen
```

## Commands

### init

Initialize a new catalog plugin with all required directories and files.

```bash
catalog-gen init <name> --entity=<EntityName> --package=<go-package> [--output=<dir>]
```

**Arguments:**
- `<name>` - Plugin name (e.g., `mcp`, `datasets`)

**Flags:**
- `--entity` (required) - Name of the main entity type (e.g., `McpServer`, `Dataset`)
- `--package` (required) - Full Go package path (e.g., `github.com/kubeflow/model-registry/catalog/plugins/mcp`)
- `--output` - Output directory (defaults to `<name>`)

**Example:**

```bash
catalog-gen init mcp \
  --entity=McpServer \
  --package=github.com/kubeflow/model-registry/catalog/plugins/mcp
```

**Generated files:**

| File | Purpose | Regenerated by `generate`? |
|------|---------|---------------------------|
| `catalog.yaml` | Plugin schema definition | No (user-editable) |
| `plugin.go` | Plugin implementation | Yes |
| `register.go` | init() auto-registration | Yes |
| `internal/db/models/<entity>.go` | GORM entity model | Yes |
| `internal/db/service/<entity>.go` | Service/repository layer | No (user-editable) |
| `internal/db/service/spec.go` | Datastore specification | Yes |
| `internal/db/service/filter_mappings.go` | filterQuery field mapping | Yes |
| `internal/catalog/loader.go` | Source loading and hot-reload | Yes |
| `internal/catalog/providers/yaml_provider.go` | YAML data provider | No (user-editable) |
| `internal/server/openapi/api_*_service_impl.go` | API endpoint logic | No (user-editable) |
| `api/openapi/` | OpenAPI specification files | Yes |

### generate

Regenerate code from the current `catalog.yaml`. Must be run from the plugin directory (where `catalog.yaml` is located).

```bash
catalog-gen generate
```

This reads `catalog.yaml` and regenerates all non-editable files. Editable files (service layer, providers, API impl) are only created by `init` and never overwritten.

**When to run:**
- After adding or modifying properties in `catalog.yaml`
- After adding artifacts with `add-artifact`
- After adding providers with `add-provider`

**After running, also execute:**

```bash
make gen/openapi-server
```

This regenerates the OpenAPI router, controller, and type definitions from the generated spec.

### add-artifact

Add a new artifact type linked to the main entity.

```bash
catalog-gen add-artifact <ArtifactName>
```

**Example:**

```bash
catalog-gen add-artifact Tool
catalog-gen add-artifact Resource
```

This:
1. Adds the artifact to `catalog.yaml` under `spec.artifacts` with a default `uri` property
2. Generates a stub model file at `internal/db/models/<artifact>.go`

After adding an artifact, run `catalog-gen generate` and `make gen/openapi-server` to regenerate all code, then:
- Update `plugin.go` to add the artifact repository to `initServices()`
- Implement the artifact list endpoint in `api_*_service_impl.go`

### add-provider

Add a new data provider type to the plugin.

```bash
catalog-gen add-provider <type>
```

**Supported types:**
- `yaml` - File-based provider using YAML catalog files
- `http` - HTTP-based provider for remote APIs

**Example:**

```bash
catalog-gen add-provider yaml
catalog-gen add-provider http
```

This:
1. Adds the provider to `catalog.yaml` under `spec.providers`
2. Generates a provider implementation file at `internal/catalog/providers/<type>_provider.go`

### gen-testdata

Generate sample test data files for local testing.

```bash
catalog-gen gen-testdata
```

This creates:
- `testdata/<entity>s.yaml` - Sample entity data with all properties populated
- `testdata/<entity>-sources.yaml` - Loader configuration pointing to the sample data
- `testdata/test-sources.yaml` - Catalog server configuration for testing

## The catalog.yaml Configuration

The `catalog.yaml` file is the single source of truth for your plugin's schema. It follows this structure:

```yaml
apiVersion: catalog.kubeflow.org/v1alpha1
kind: CatalogConfig
metadata:
  name: <plugin-name>          # e.g., "mcp"
spec:
  package: <go-package-path>   # Full Go import path
  entity:
    name: <EntityName>         # PascalCase entity name (e.g., McpServer)
    properties:                # Custom properties beyond base fields
      - name: serverUrl
        type: string
        required: true
        description: URL of the MCP server
      - name: toolCount
        type: integer
        description: Number of tools exposed
  artifacts:                   # Optional artifact types
    - name: Tool
      properties:
        - name: uri
          type: string
  providers:                   # Data provider types
    - type: yaml
  api:
    basePath: /api/<name>_catalog/v1alpha1
    port: 8081
```

### Base Fields

Every entity automatically includes these fields from `BaseResource` (do not declare them in properties):

- `name` - Entity name (string, required)
- `id` - Auto-generated ID (string)
- `externalId` - External reference ID (string)
- `description` - Human-readable description (string)
- `customProperties` - Arbitrary key-value metadata (map)
- `createTimeSinceEpoch` - Creation timestamp (string)
- `lastUpdateTimeSinceEpoch` - Last update timestamp (string)

### Property Types

| YAML Type | Go Type    | OpenAPI Type           |
|-----------|------------|------------------------|
| `string`  | `*string`  | `string`               |
| `integer` | `*int32`   | `integer`              |
| `int64`   | `*int64`   | `integer` (format: int64) |
| `boolean` | `*bool`    | `boolean`              |
| `number`  | `*float64` | `number`               |
| `array`   | `[]string` | `array`                |

## Editable vs Non-Editable Files

`catalog-gen` maintains a strict separation:

**Non-editable (regenerated on every `generate`):**
- `plugin.go`, `register.go`
- `internal/db/models/*.go` (entity and artifact models)
- `internal/db/service/spec.go` (datastore spec)
- `internal/db/service/filter_mappings.go` (filter field mapping)
- `internal/catalog/loader.go`
- `api/openapi/` (OpenAPI spec files)

**Editable (created once by `init`, never overwritten):**
- `catalog.yaml`
- `internal/db/service/<entity>.go` (service layer)
- `internal/catalog/providers/yaml_provider.go`
- `internal/server/openapi/api_*_service_impl.go` (API business logic)

This means you can safely run `catalog-gen generate` after changing `catalog.yaml` without losing your custom business logic.

## Typical Workflow

```bash
# 1. Create plugin
catalog-gen init mcp --entity=McpServer --package=github.com/kubeflow/model-registry/catalog/plugins/mcp

# 2. Edit catalog.yaml to define properties
vim catalog.yaml

# 3. Regenerate code
catalog-gen generate
make gen/openapi-server

# 4. Implement business logic
vim internal/server/openapi/api_mcpserver_service_impl.go
vim internal/catalog/providers/yaml_provider.go

# 5. Generate test data
catalog-gen gen-testdata

# 6. Build and test
go build ./...
go test ./...

# 7. Later: add a property
vim catalog.yaml  # Add new property
catalog-gen generate
make gen/openapi-server
# Update service impl and provider for new property

# 8. Later: add an artifact type
catalog-gen add-artifact Tool
catalog-gen generate
make gen/openapi-server
# Implement artifact endpoint in service impl
```
