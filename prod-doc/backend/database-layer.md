# Database Layer

This document covers GORM usage, code generation, migrations, and database schema in the Model Registry.

## Overview

**Location:** `internal/db/`

**Key Directories:**
- `schema/` - GORM-generated schema structs
- `service/` - Repository implementations
- `models/` - Domain model definitions
- `scopes/` - GORM scopes for pagination/filtering
- `filter/` - Advanced query filtering

## Supported Databases

| Database | Version | Driver |
|----------|---------|--------|
| MySQL | 8.3+ | `gorm.io/driver/mysql` |
| PostgreSQL | 13+ | `gorm.io/driver/postgres` |

## GORM Schema Generation

### Workflow

```
Database Schema (migrations)
        │
        ▼
Start Database (Docker)
   make start/mysql
        │
        ▼
Run Migrations
        │
        ▼
Generate GORM Structs
   make gen/gorm
        │
        ▼
Generated Files
   internal/db/schema/*.gen.go
```

### Generation Command

```bash
# MySQL (default)
make gen/gorm

# PostgreSQL
GORM_DB_TYPE=postgres make gen/gorm
```

### Generated Structs

```go
// internal/db/schema/artifact.gen.go
// Code generated by gorm.io/gen. DO NOT EDIT.

package schema

type Artifact struct {
    ID                       int32   `gorm:"column:id;primaryKey;autoIncrement:true"`
    TypeID                   int32   `gorm:"column:type_id;not null"`
    URI                      *string `gorm:"column:uri"`
    State                    *int32  `gorm:"column:state"`
    Name                     *string `gorm:"column:name"`
    ExternalID               *string `gorm:"column:external_id"`
    CreateTimeSinceEpoch     int64   `gorm:"column:create_time_since_epoch;not null"`
    LastUpdateTimeSinceEpoch int64   `gorm:"column:last_update_time_since_epoch;not null"`
}

func (Artifact) TableName() string {
    return "Artifact"
}
```

## Database Migrations

### Location

- MySQL: `internal/datastore/embedmd/mysql/migrations/`
- PostgreSQL: `internal/datastore/embedmd/postgres/migrations/`

### Embedded Migrations

```go
// internal/datastore/embedmd/mysql/migrate.go
//go:embed migrations/*.sql
var migrations embed.FS

type MySQLMigrator struct {
    migrator *migrate.Migrate
}

func NewMySQLMigrator(db *gorm.DB) (*MySQLMigrator, error) {
    sqlDB, err := db.DB()
    if err != nil {
        return nil, err
    }

    driver, err := mysql.WithInstance(sqlDB, &mysql.Config{})
    if err != nil {
        return nil, err
    }

    source, err := iofs.New(migrations, "migrations")
    if err != nil {
        return nil, err
    }

    m, err := migrate.NewWithInstance("iofs", source, "mysql", driver)
    if err != nil {
        return nil, err
    }

    return &MySQLMigrator{migrator: m}, nil
}

func (m *MySQLMigrator) Migrate() error {
    return m.migrator.Up()
}
```

### Migration Files

```sql
-- 000001_initial_schema.up.sql
CREATE TABLE IF NOT EXISTS Type (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL UNIQUE,
    version VARCHAR(255),
    type_kind VARCHAR(50),
    description TEXT,
    external_id VARCHAR(255)
);

CREATE TABLE IF NOT EXISTS Context (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type_id INT NOT NULL,
    name VARCHAR(255),
    external_id VARCHAR(255),
    create_time_since_epoch BIGINT NOT NULL DEFAULT 0,
    last_update_time_since_epoch BIGINT NOT NULL DEFAULT 0,
    FOREIGN KEY (type_id) REFERENCES Type(id)
);

-- ... additional tables
```

### Migration Commands

```bash
# Run migrations
make migrate/up

# Rollback one step
make migrate/down

# Check migration status
make migrate/status
```

## Database Connector

### Singleton Pattern

```go
// internal/db/connector.go
var (
    _connectorInstance *Connector
    _connectorMutex    sync.RWMutex
)

type Connector struct {
    db       *gorm.DB
    dbType   string
    migrator Migrator
}

func Init(dbType, dsn string, tlsConfig *tls.TLSConfig) error {
    _connectorMutex.Lock()
    defer _connectorMutex.Unlock()

    if _connectorInstance != nil {
        return errors.New("connector already initialized")
    }

    var db *gorm.DB
    var err error

    switch dbType {
    case "mysql":
        db, err = gorm.Open(mysql.Open(dsn), &gorm.Config{})
    case "postgres":
        db, err = gorm.Open(postgres.Open(dsn), &gorm.Config{})
    default:
        return fmt.Errorf("unsupported database type: %s", dbType)
    }

    if err != nil {
        return err
    }

    _connectorInstance = &Connector{
        db:     db,
        dbType: dbType,
    }

    return nil
}

func GetConnector() (*Connector, error) {
    _connectorMutex.RLock()
    defer _connectorMutex.RUnlock()

    if _connectorInstance == nil {
        return nil, errors.New("connector not initialized")
    }

    return _connectorInstance, nil
}
```

## Schema Overview

### Core Tables

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Type Table                                      │
│  (Defines entity types: RegisteredModel, ModelVersion, etc.)                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │   Context   │ │  Artifact   │ │  Execution  │
            │             │ │             │ │             │
            │ - id        │ │ - id        │ │ - id        │
            │ - type_id   │ │ - type_id   │ │ - type_id   │
            │ - name      │ │ - uri       │ │ - name      │
            │ - ...       │ │ - state     │ │ - state     │
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │               │               │
                   ▼               ▼               ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │ Context     │ │ Artifact    │ │ Execution   │
            │ Property    │ │ Property    │ │ Property    │
            └─────────────┘ └─────────────┘ └─────────────┘
```

### Relationship Tables

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Relationship Tables                                 │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │  ParentContext  │  │   Attribution   │  │   Association   │             │
│  │                 │  │                 │  │                 │             │
│  │ context_id      │  │ context_id      │  │ context_id      │             │
│  │ parent_ctx_id   │  │ artifact_id     │  │ execution_id    │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │      Event      │  │    EventPath    │                                  │
│  │                 │  │                 │                                  │
│  │ artifact_id     │  │ event_id        │                                  │
│  │ execution_id    │  │ path            │                                  │
│  │ type            │  │ index           │                                  │
│  └─────────────────┘  └─────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Property Storage

### Property Table Schema

```sql
CREATE TABLE ContextProperty (
    context_id INT NOT NULL,
    name VARCHAR(255) NOT NULL,
    is_custom_property BOOLEAN NOT NULL DEFAULT FALSE,
    int_value INT,
    double_value DOUBLE,
    string_value MEDIUMTEXT,
    bool_value BOOLEAN,
    byte_value MEDIUMBLOB,
    proto_value MEDIUMBLOB,
    PRIMARY KEY (context_id, name, is_custom_property),
    FOREIGN KEY (context_id) REFERENCES Context(id) ON DELETE CASCADE
);
```

### Property Types

| Column | Go Type | Use Case |
|--------|---------|----------|
| `int_value` | `*int32` | Counts, IDs |
| `double_value` | `*float64` | Metrics, scores |
| `string_value` | `*string` | Text, enums |
| `bool_value` | `*bool` | Flags |
| `byte_value` | `*[]byte` | Binary data |
| `proto_value` | `*[]byte` | Protobuf messages |

## Connection Configuration

### MySQL DSN Format

```
username:password@tcp(host:port)/database?parseTime=true&charset=utf8mb4
```

### PostgreSQL DSN Format

```
host=localhost port=5432 user=username password=password dbname=database sslmode=disable
```

### TLS Configuration

```go
type TLSConfig struct {
    CertFile       string
    KeyFile        string
    CAFile         string
    ServerName     string
    InsecureSkipVerify bool
}
```

## GORM Configuration

```go
gormConfig := &gorm.Config{
    Logger: logger.Default.LogMode(logger.Info),
    NamingStrategy: schema.NamingStrategy{
        SingularTable: true, // Use singular table names
    },
}

db, err := gorm.Open(mysql.Open(dsn), gormConfig)
```

## Connection Pooling

```go
sqlDB, _ := db.DB()

// Set connection pool settings
sqlDB.SetMaxIdleConns(10)
sqlDB.SetMaxOpenConns(100)
sqlDB.SetConnMaxLifetime(time.Hour)
```

## MySQL vs PostgreSQL Differences

| Feature | MySQL | PostgreSQL |
|---------|-------|------------|
| Auto Increment | `AUTO_INCREMENT` | `SERIAL` |
| Boolean | `TINYINT(1)` | `BOOLEAN` |
| Text | `MEDIUMTEXT` | `TEXT` |
| Binary | `MEDIUMBLOB` | `BYTEA` |
| Case Sensitivity | Case-insensitive | Case-sensitive |

## Development Scripts

```bash
# Start MySQL for development
make start/mysql

# Stop MySQL
make stop/mysql

# Start PostgreSQL
make start/postgres

# Stop PostgreSQL
make stop/postgres

# Clean database
make clean/db
```

---

[Back to Backend Index](./README.md) | [Previous: Datastore Abstraction](./datastore-abstraction.md) | [Next: Converter/Mapper](./converter-mapper.md)
